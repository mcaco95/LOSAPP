{% extends "base.html" %}

{% block title %}Manage Commission Partners{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="row">
        <div class="col-12">
            <div class="card">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h5 class="card-title mb-0">Commission Partners</h5>
                    <div>
                        <a href="{{ url_for('commission.admin_commissions') }}" class="btn btn-sm btn-outline-primary">View Commissions</a>
                    </div>
                </div>
                <div class="card-body">
                    <!-- Filter Controls -->
                    <div class="row mb-4">
                        <div class="col-md-6">
                            <div class="btn-group" role="group">
                                <button type="button" class="btn btn-outline-primary active filter-btn" data-filter="all">All</button>
                                <button type="button" class="btn btn-outline-success filter-btn" data-filter="active">Active</button>
                                <button type="button" class="btn btn-outline-danger filter-btn" data-filter="inactive">Inactive</button>
                            </div>
                        </div>
                        <div class="col-md-6 text-end">
                            <div class="input-group" style="max-width: 300px; float: right;">
                                <input type="text" class="form-control" id="searchInput" placeholder="Search partners...">
                                <button class="btn btn-outline-secondary" type="button">
                                    <i class="fas fa-search"></i>
                                </button>
                            </div>
                        </div>
                    </div>

                    <!-- Partners Table -->
                    <div class="table-responsive">
                        <table class="table table-striped table-hover" id="partnersTable">
                            <thead>
                                <tr>
                                    <th>ID</th>
                                    <th>Partner</th>
                                    <th>Email</th>
                                    <th>Joined</th>
                                    <th>Tier</th>
                                    <th>Referrer</th>
                                    <th>Network Size</th>
                                    <th>Status</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for partner in partners %}
                                <tr data-status="{{ 'active' if partner.is_active else 'inactive' }}">
                                    <td>#{{ partner.id }}</td>
                                    <td>
                                        <div class="d-flex align-items-center">
                                            <div class="avatar avatar-sm me-2 bg-primary">
                                                <div class="avatar-content">{{ partner.user.name[:1] if partner.user.name else partner.user.username[:1] }}</div>
                                            </div>
                                            <div>{{ partner.user.name or partner.user.username }}</div>
                                        </div>
                                    </td>
                                    <td>{{ partner.user.email }}</td>
                                    <td>{{ partner.created_at.strftime('%Y-%m-%d') }}</td>
                                    <td>
                                        <span class="badge bg-{{ 'primary' if partner.commission_tier == 'premium' else 'secondary' }}">
                                            {{ partner.commission_tier|title }}
                                        </span>
                                    </td>
                                    <td>
                                        {% if partner.referrer %}
                                            {{ partner.referrer.user.name or partner.referrer.user.username }}
                                        {% else %}
                                            <span class="text-muted">None</span>
                                        {% endif %}
                                    </td>
                                    <td>{{ partner.referred_count }}</td>
                                    <td>
                                        {% if partner.is_active %}
                                            <span class="badge bg-success">Active</span>
                                        {% else %}
                                            <span class="badge bg-danger">Inactive</span>
                                        {% endif %}
                                    </td>
                                    <td>
                                        <div class="dropdown">
                                            <button class="btn btn-sm btn-outline-secondary dropdown-toggle" type="button" id="dropdownMenuButton{{ partner.id }}" data-bs-toggle="dropdown" aria-expanded="false">
                                                Actions
                                            </button>
                                            <ul class="dropdown-menu" aria-labelledby="dropdownMenuButton{{ partner.id }}">
                                                <li>
                                                    <a class="dropdown-item" href="#" data-bs-toggle="modal" data-bs-target="#viewPartnerModal" 
                                                       data-partner-id="{{ partner.id }}" 
                                                       data-partner-name="{{ partner.user.name or partner.user.username }}"
                                                       data-partner-email="{{ partner.user.email }}">
                                                        <i class="fas fa-eye me-1"></i> View Details
                                                    </a>
                                                </li>
                                                <li>
                                                    <a class="dropdown-item" href="#" data-bs-toggle="modal" data-bs-target="#editTierModal" 
                                                       data-partner-id="{{ partner.id }}" 
                                                       data-partner-name="{{ partner.user.name or partner.user.username }}"
                                                       data-partner-tier="{{ partner.commission_tier }}">
                                                        <i class="fas fa-edit me-1"></i> Edit Tier
                                                    </a>
                                                </li>
                                                <li><hr class="dropdown-divider"></li>
                                                {% if partner.is_active %}
                                                <li>
                                                    <a class="dropdown-item text-danger" href="#" data-bs-toggle="modal" data-bs-target="#deactivatePartnerModal" 
                                                       data-partner-id="{{ partner.id }}" 
                                                       data-partner-name="{{ partner.user.name or partner.user.username }}">
                                                        <i class="fas fa-ban me-1"></i> Deactivate
                                                    </a>
                                                </li>
                                                {% else %}
                                                <li>
                                                    <a class="dropdown-item text-success" href="#" data-bs-toggle="modal" data-bs-target="#activatePartnerModal" 
                                                       data-partner-id="{{ partner.id }}" 
                                                       data-partner-name="{{ partner.user.name or partner.user.username }}">
                                                        <i class="fas fa-check-circle me-1"></i> Activate
                                                    </a>
                                                </li>
                                                {% endif %}
                                            </ul>
                                        </div>
                                    </td>
                                </tr>
                                {% else %}
                                <tr>
                                    <td colspan="9" class="text-center">
                                        <div class="py-4">
                                            <i class="align-middle fas fa-fw fa-users fa-3x mb-3 text-muted"></i>
                                            <h5>No commission partners found</h5>
                                        </div>
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>

                    <!-- Pagination -->
                    {% if partners and partners|length > 20 %}
                    <nav aria-label="Page navigation" class="mt-4">
                        <ul class="pagination justify-content-center">
                            <li class="page-item disabled">
                                <a class="page-link" href="#" tabindex="-1">Previous</a>
                            </li>
                            <li class="page-item active"><a class="page-link" href="#">1</a></li>
                            <li class="page-item"><a class="page-link" href="#">2</a></li>
                            <li class="page-item"><a class="page-link" href="#">3</a></li>
                            <li class="page-item">
                                <a class="page-link" href="#">Next</a>
                            </li>
                        </ul>
                    </nav>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
</div>

<!-- View Partner Modal -->
<div class="modal fade" id="viewPartnerModal" tabindex="-1" aria-labelledby="viewPartnerModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="viewPartnerModalLabel">Partner Details</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="row">
                    <div class="col-md-6">
                        <h6>Basic Information</h6>
                        <table class="table table-sm">
                            <tr>
                                <th>Name:</th>
                                <td id="partnerDetailName"></td>
                            </tr>
                            <tr>
                                <th>Email:</th>
                                <td id="partnerDetailEmail"></td>
                            </tr>
                            <tr>
                                <th>Joined:</th>
                                <td id="partnerDetailJoined"></td>
                            </tr>
                            <tr>
                                <th>Status:</th>
                                <td id="partnerDetailStatus"></td>
                            </tr>
                            <tr>
                                <th>Tier:</th>
                                <td id="partnerDetailTier"></td>
                            </tr>
                        </table>
                    </div>
                    <div class="col-md-6">
                        <h6>Commission Information</h6>
                        <table class="table table-sm">
                            <tr>
                                <th>Total Commissions:</th>
                                <td id="partnerDetailCommissions"></td>
                            </tr>
                            <tr>
                                <th>Pending Commissions:</th>
                                <td id="partnerDetailPending"></td>
                            </tr>
                            <tr>
                                <th>Paid Commissions:</th>
                                <td id="partnerDetailPaid"></td>
                            </tr>
                            <tr>
                                <th>Network Size:</th>
                                <td id="partnerDetailNetwork"></td>
                            </tr>
                            <tr>
                                <th>Active Companies:</th>
                                <td id="partnerDetailCompanies"></td>
                            </tr>
                        </table>
                    </div>
                </div>
                
                <div class="mt-4">
                    <h6>Custom Commission Rates</h6>
                    <div class="form-check form-switch mb-3">
                        <input class="form-check-input" type="checkbox" id="customRatesSwitch">
                        <label class="form-check-label" for="customRatesSwitch">Enable Custom Rates</label>
                    </div>
                    
                    <div id="customRatesForm" style="display: none;">
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label class="form-label">Standard Plan - Initial</label>
                                    <div class="input-group">
                                        <input type="number" class="form-control" id="standardInitialRate" min="0" max="1" step="0.01" value="0.20">
                                        <span class="input-group-text">%</span>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label class="form-label">Standard Plan - Recurring</label>
                                    <div class="input-group">
                                        <input type="number" class="form-control" id="standardRecurringRate" min="0" max="1" step="0.01" value="0.025">
                                        <span class="input-group-text">%</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label class="form-label">Professional Plan - Initial</label>
                                    <div class="input-group">
                                        <input type="number" class="form-control" id="professionalInitialRate" min="0" max="1" step="0.01" value="0.20">
                                        <span class="input-group-text">%</span>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label class="form-label">Professional Plan - Recurring</label>
                                    <div class="input-group">
                                        <input type="number" class="form-control" id="professionalRecurringRate" min="0" max="1" step="0.01" value="0.025">
                                        <span class="input-group-text">%</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <button type="button" class="btn btn-primary">Save Custom Rates</button>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                <a href="#" class="btn btn-primary" id="viewCommissionsBtn">View Commissions</a>
            </div>
        </div>
    </div>
</div>

<!-- Edit Tier Modal -->
<div class="modal fade" id="editTierModal" tabindex="-1" aria-labelledby="editTierModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="editTierModalLabel">Edit Partner Tier</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="editTierForm">
                    <input type="hidden" id="editPartnerId">
                    <div class="mb-3">
                        <label class="form-label">Partner</label>
                        <input type="text" class="form-control" id="editPartnerName" readonly>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Commission Tier</label>
                        <select class="form-select" id="editPartnerTier">
                            <option value="standard">Standard</option>
                            <option value="premium">Premium</option>
                        </select>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" id="saveTierBtn">Save Changes</button>
            </div>
        </div>
    </div>
</div>

<!-- Deactivate Partner Modal -->
<div class="modal fade" id="deactivatePartnerModal" tabindex="-1" aria-labelledby="deactivatePartnerModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="deactivatePartnerModalLabel">Deactivate Partner</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <p>Are you sure you want to deactivate <strong id="deactivatePartnerName"></strong>?</p>
                <p>This will prevent them from earning new commissions, but existing commissions will still be processed.</p>
                <div class="mb-3">
                    <label class="form-label">Reason for Deactivation</label>
                    <textarea class="form-control" id="deactivateReason" rows="3"></textarea>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-danger" id="confirmDeactivateBtn">Deactivate Partner</button>
            </div>
        </div>
    </div>
</div>

<!-- Activate Partner Modal -->
<div class="modal fade" id="activatePartnerModal" tabindex="-1" aria-labelledby="activatePartnerModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="activatePartnerModalLabel">Activate Partner</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <p>Are you sure you want to activate <strong id="activatePartnerName"></strong>?</p>
                <p>This will allow them to earn commissions again.</p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-success" id="confirmActivateBtn">Activate Partner</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    document.addEventListener("DOMContentLoaded", function() {
        // Table search functionality
        document.getElementById('searchInput').addEventListener('keyup', function() {
            var input, filter, table, tr, td, i, txtValue;
            input = document.getElementById('searchInput');
            filter = input.value.toUpperCase();
            table = document.getElementById('partnersTable');
            tr = table.getElementsByTagName('tr');

            for (i = 1; i < tr.length; i++) {
                var found = false;
                var tds = tr[i].getElementsByTagName('td');
                
                for (var j = 0; j < tds.length; j++) {
                    td = tds[j];
                    if (td) {
                        txtValue = td.textContent || td.innerText;
                        if (txtValue.toUpperCase().indexOf(filter) > -1) {
                            found = true;
                            break;
                        }
                    }
                }
                
                if (found) {
                    tr[i].style.display = '';
                } else {
                    tr[i].style.display = 'none';
                }
            }
        });
        
        // Filter buttons
        document.querySelectorAll('.filter-btn').forEach(function(btn) {
            btn.addEventListener('click', function() {
                // Update active button
                document.querySelectorAll('.filter-btn').forEach(function(b) {
                    b.classList.remove('active');
                });
                this.classList.add('active');
                
                // Filter table
                var filter = this.getAttribute('data-filter');
                var table = document.getElementById('partnersTable');
                var tr = table.getElementsByTagName('tr');
                
                for (var i = 1; i < tr.length; i++) {
                    if (tr[i].hasAttribute('data-status')) {
                        var status = tr[i].getAttribute('data-status');
                        if (filter === 'all' || status === filter) {
                            tr[i].style.display = '';
                        } else {
                            tr[i].style.display = 'none';
                        }
                    }
                }
            });
        });
        
        // Custom rates toggle
        document.getElementById('customRatesSwitch').addEventListener('change', function() {
            var customRatesForm = document.getElementById('customRatesForm');
            if (this.checked) {
                customRatesForm.style.display = 'block';
            } else {
                customRatesForm.style.display = 'none';
            }
        });
        
        // View Partner Modal
        var viewPartnerModal = document.getElementById('viewPartnerModal');
        if (viewPartnerModal) {
            viewPartnerModal.addEventListener('show.bs.modal', function(event) {
                var button = event.relatedTarget;
                var partnerId = button.getAttribute('data-partner-id');
                var partnerName = button.getAttribute('data-partner-name');
                var partnerEmail = button.getAttribute('data-partner-email');
                
                // Update modal content with partner details
                document.getElementById('partnerDetailName').textContent = partnerName;
                document.getElementById('partnerDetailEmail').textContent = partnerEmail;
                
                // Update view commissions link
                document.getElementById('viewCommissionsBtn').href = '/commission/admin/partner/' + partnerId + '/commissions';
                
                // TODO: Fetch additional partner details via AJAX
            });
        }
        
        // Edit Tier Modal
        var editTierModal = document.getElementById('editTierModal');
        if (editTierModal) {
            editTierModal.addEventListener('show.bs.modal', function(event) {
                var button = event.relatedTarget;
                var partnerId = button.getAttribute('data-partner-id');
                var partnerName = button.getAttribute('data-partner-name');
                var partnerTier = button.getAttribute('data-partner-tier');
                
                document.getElementById('editPartnerId').value = partnerId;
                document.getElementById('editPartnerName').value = partnerName;
                document.getElementById('editPartnerTier').value = partnerTier;
            });
        }
        
        // Deactivate Partner Modal
        var deactivatePartnerModal = document.getElementById('deactivatePartnerModal');
        if (deactivatePartnerModal) {
            deactivatePartnerModal.addEventListener('show.bs.modal', function(event) {
                var button = event.relatedTarget;
                var partnerId = button.getAttribute('data-partner-id');
                var partnerName = button.getAttribute('data-partner-name');
                
                document.getElementById('deactivatePartnerName').textContent = partnerName;
                document.getElementById('confirmDeactivateBtn').setAttribute('data-partner-id', partnerId);
            });
        }
        
        // Activate Partner Modal
        var activatePartnerModal = document.getElementById('activatePartnerModal');
        if (activatePartnerModal) {
            activatePartnerModal.addEventListener('show.bs.modal', function(event) {
                var button = event.relatedTarget;
                var partnerId = button.getAttribute('data-partner-id');
                var partnerName = button.getAttribute('data-partner-name');
                
                document.getElementById('activatePartnerName').textContent = partnerName;
                document.getElementById('confirmActivateBtn').setAttribute('data-partner-id', partnerId);
            });
        }
        
        // Save Tier Button
        document.getElementById('saveTierBtn').addEventListener('click', function() {
            var partnerId = document.getElementById('editPartnerId').value;
            var tier = document.getElementById('editPartnerTier').value;
            
            // TODO: Send AJAX request to update partner tier
            console.log('Update partner', partnerId, 'to tier', tier);
            
            // Close modal
            var modal = bootstrap.Modal.getInstance(document.getElementById('editTierModal'));
            modal.hide();
            
            // Show success message
            alert('Partner tier updated successfully!');
        });
        
        // Confirm Deactivate Button
        document.getElementById('confirmDeactivateBtn').addEventListener('click', function() {
            var partnerId = this.getAttribute('data-partner-id');
            var reason = document.getElementById('deactivateReason').value;
            
            // TODO: Send AJAX request to deactivate partner
            console.log('Deactivate partner', partnerId, 'reason:', reason);
            
            // Close modal
            var modal = bootstrap.Modal.getInstance(document.getElementById('deactivatePartnerModal'));
            modal.hide();
            
            // Show success message
            alert('Partner deactivated successfully!');
        });
        
        // Confirm Activate Button
        document.getElementById('confirmActivateBtn').addEventListener('click', function() {
            var partnerId = this.getAttribute('data-partner-id');
            
            // TODO: Send AJAX request to activate partner
            console.log('Activate partner', partnerId);
            
            // Close modal
            var modal = bootstrap.Modal.getInstance(document.getElementById('activatePartnerModal'));
            modal.hide();
            
            // Show success message
            alert('Partner activated successfully!');
        });
    });
</script>
{% endblock %} 