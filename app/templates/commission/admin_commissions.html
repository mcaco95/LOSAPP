{% extends "base.html" %}

{% block title %}Manage Commissions{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="row">
        <div class="col-12">
            <div class="card">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h5 class="card-title mb-0">Commissions</h5>
                    <div>
                        <a href="{{ url_for('commission.admin_partners') }}" class="btn btn-sm btn-outline-primary">Manage Partners</a>
                    </div>
                </div>
                <div class="card-body">
                    <!-- Filter Controls -->
                    <div class="row mb-4">
                        <div class="col-md-6">
                            <div class="btn-group" role="group">
                                <a href="{{ url_for('commission.admin_commissions') }}" class="btn btn-outline-primary {{ 'active' if not request.args.get('status') }}">All</a>
                                <a href="{{ url_for('commission.admin_commissions', status='pending') }}" class="btn btn-outline-warning {{ 'active' if request.args.get('status') == 'pending' }}">Pending</a>
                                <a href="{{ url_for('commission.admin_commissions', status='paid') }}" class="btn btn-outline-success {{ 'active' if request.args.get('status') == 'paid' }}">Paid</a>
                                <a href="{{ url_for('commission.admin_commissions', status='cancelled') }}" class="btn btn-outline-danger {{ 'active' if request.args.get('status') == 'cancelled' }}">Cancelled</a>
                            </div>
                        </div>
                        <div class="col-md-6 text-end">
                            <div class="input-group" style="max-width: 300px; float: right;">
                                <input type="text" class="form-control" id="searchInput" placeholder="Search commissions...">
                                <button class="btn btn-outline-secondary" type="button">
                                    <i class="fas fa-search"></i>
                                </button>
                            </div>
                        </div>
                    </div>

                    <!-- Commissions Table -->
                    <div class="table-responsive">
                        <table class="table table-striped table-hover" id="commissionsTable">
                            <thead>
                                <tr>
                                    <th>ID</th>
                                    <th>Partner</th>
                                    <th>Company</th>
                                    <th>Service Type</th>
                                    <th>Month</th>
                                    <th>Amount</th>
                                    <th>Status</th>
                                    <th>Created</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for commission in commissions %}
                                <tr>
                                    <td>#{{ commission.id }}</td>
                                    <td>
                                        <div class="d-flex align-items-center">
                                            <div class="avatar avatar-sm me-2 bg-primary">
                                                <div class="avatar-content">{{ commission.partner.user.name[:1] if commission.partner.user.name else commission.partner.user.username[:1] }}</div>
                                            </div>
                                            <div>{{ commission.partner.user.name or commission.partner.user.username }}</div>
                                        </div>
                                    </td>
                                    <td>{{ commission.company.name }}</td>
                                    <td>
                                        {% if commission.service_type == 'professional' %}
                                            <span class="badge bg-primary">Professional</span>
                                        {% else %}
                                            <span class="badge bg-secondary">Standard</span>
                                        {% endif %}
                                    </td>
                                    <td>
                                        {% if commission.is_initial_month %}
                                            <span class="badge bg-info">Initial</span>
                                        {% else %}
                                            Month {{ commission.month_number }}
                                        {% endif %}
                                    </td>
                                    <td>${{ "%.2f"|format(commission.amount) }}</td>
                                    <td>
                                        {% if commission.status == 'pending' %}
                                            <span class="badge bg-warning">Pending</span>
                                        {% elif commission.status == 'paid' %}
                                            <span class="badge bg-success">Paid</span>
                                        {% else %}
                                            <span class="badge bg-danger">Cancelled</span>
                                            {% if commission.commission_metadata and commission.commission_metadata.cancellation_reason %}
                                                <i class="fas fa-info-circle" data-bs-toggle="tooltip" title="{{ commission.commission_metadata.cancellation_reason }}"></i>
                                            {% endif %}
                                        {% endif %}
                                    </td>
                                    <td>{{ commission.created_at.strftime('%Y-%m-%d') }}</td>
                                    <td>
                                        <div class="dropdown">
                                            <button class="btn btn-sm btn-outline-secondary dropdown-toggle" type="button" id="dropdownMenuButton{{ commission.id }}" data-bs-toggle="dropdown" aria-expanded="false">
                                                Actions
                                            </button>
                                            <ul class="dropdown-menu" aria-labelledby="dropdownMenuButton{{ commission.id }}">
                                                <li>
                                                    <a class="dropdown-item" href="#" data-bs-toggle="modal" data-bs-target="#viewCommissionModal" 
                                                       data-commission-id="{{ commission.id }}">
                                                        <i class="fas fa-eye me-1"></i> View Details
                                                    </a>
                                                </li>
                                                {% if commission.status == 'pending' %}
                                                <li>
                                                    <a class="dropdown-item text-success" href="#" data-bs-toggle="modal" data-bs-target="#markPaidModal" 
                                                       data-commission-id="{{ commission.id }}"
                                                       data-commission-amount="{{ commission.amount }}"
                                                       data-partner-name="{{ commission.partner.user.name or commission.partner.user.username }}">
                                                        <i class="fas fa-check-circle me-1"></i> Mark as Paid
                                                    </a>
                                                </li>
                                                <li>
                                                    <a class="dropdown-item text-danger" href="#" data-bs-toggle="modal" data-bs-target="#cancelCommissionModal" 
                                                       data-commission-id="{{ commission.id }}"
                                                       data-partner-name="{{ commission.partner.user.name or commission.partner.user.username }}">
                                                        <i class="fas fa-ban me-1"></i> Cancel Commission
                                                    </a>
                                                </li>
                                                {% endif %}
                                            </ul>
                                        </div>
                                    </td>
                                </tr>
                                {% else %}
                                <tr>
                                    <td colspan="9" class="text-center">
                                        <div class="py-4">
                                            <i class="align-middle fas fa-fw fa-file-invoice-dollar fa-3x mb-3 text-muted"></i>
                                            <h5>No commissions found</h5>
                                            <p class="text-muted">
                                                {% if request.args.get('status') %}
                                                    No {{ request.args.get('status') }} commissions found.
                                                {% else %}
                                                    There are no commissions in the system yet.
                                                {% endif %}
                                            </p>
                                        </div>
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>

                    <!-- Pagination -->
                    {% if commissions and commissions|length > 20 %}
                    <nav aria-label="Page navigation" class="mt-4">
                        <ul class="pagination justify-content-center">
                            <li class="page-item disabled">
                                <a class="page-link" href="#" tabindex="-1">Previous</a>
                            </li>
                            <li class="page-item active"><a class="page-link" href="#">1</a></li>
                            <li class="page-item"><a class="page-link" href="#">2</a></li>
                            <li class="page-item"><a class="page-link" href="#">3</a></li>
                            <li class="page-item">
                                <a class="page-link" href="#">Next</a>
                            </li>
                        </ul>
                    </nav>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>

    <!-- Commission Summary -->
    <div class="row mt-4">
        <div class="col-md-6">
            <div class="card">
                <div class="card-header">
                    <h5 class="card-title mb-0">Commission Summary</h5>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-4">
                            <div class="card bg-primary text-white">
                                <div class="card-body py-3">
                                    <div class="d-flex align-items-center">
                                        <i class="align-middle me-3 fas fa-fw fa-dollar-sign fa-2x"></i>
                                        <div>
                                            <h5 class="card-title mb-0">Total</h5>
                                            <h2 class="mt-2 mb-0">${{ "%.2f"|format(commissions|map(attribute='amount')|sum) }}</h2>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="card bg-success text-white">
                                <div class="card-body py-3">
                                    <div class="d-flex align-items-center">
                                        <i class="align-middle me-3 fas fa-fw fa-check-circle fa-2x"></i>
                                        <div>
                                            <h5 class="card-title mb-0">Paid</h5>
                                            <h2 class="mt-2 mb-0">${{ "%.2f"|format(commissions|selectattr('status', 'equalto', 'paid')|map(attribute='amount')|sum) }}</h2>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="card bg-warning text-white">
                                <div class="card-body py-3">
                                    <div class="d-flex align-items-center">
                                        <i class="align-middle me-3 fas fa-fw fa-clock fa-2x"></i>
                                        <div>
                                            <h5 class="card-title mb-0">Pending</h5>
                                            <h2 class="mt-2 mb-0">${{ "%.2f"|format(commissions|selectattr('status', 'equalto', 'pending')|map(attribute='amount')|sum) }}</h2>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="mt-4">
                        <h6>Commission Distribution</h6>
                        <div class="chart">
                            <canvas id="commissionChart" width="100%" height="250"></canvas>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-6">
            <div class="card">
                <div class="card-header">
                    <h5 class="card-title mb-0">Bulk Actions</h5>
                </div>
                <div class="card-body">
                    <div class="mb-4">
                        <h6>Process Monthly Commissions</h6>
                        <p>Generate recurring commissions for all active clients.</p>
                        <button type="button" class="btn btn-primary" id="processMonthlyBtn">
                            <i class="fas fa-sync-alt me-1"></i> Process Monthly Commissions
                        </button>
                    </div>
                    
                    <div class="mb-4">
                        <h6>Mark Pending Commissions as Paid</h6>
                        <p>Mark all pending commissions as paid in bulk.</p>
                        <button type="button" class="btn btn-success" data-bs-toggle="modal" data-bs-target="#bulkPayModal">
                            <i class="fas fa-check-circle me-1"></i> Pay All Pending Commissions
                        </button>
                    </div>
                    
                    <div>
                        <h6>Export Commissions</h6>
                        <p>Export commission data for accounting purposes.</p>
                        <div class="btn-group">
                            <button type="button" class="btn btn-outline-primary" id="exportCsvBtn">
                                <i class="fas fa-file-csv me-1"></i> Export CSV
                            </button>
                            <button type="button" class="btn btn-outline-primary" id="exportExcelBtn">
                                <i class="fas fa-file-excel me-1"></i> Export Excel
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- View Commission Modal -->
<div class="modal fade" id="viewCommissionModal" tabindex="-1" aria-labelledby="viewCommissionModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="viewCommissionModalLabel">Commission Details</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="row">
                    <div class="col-md-6">
                        <h6>Commission Information</h6>
                        <table class="table table-sm">
                            <tr>
                                <th>Commission ID:</th>
                                <td id="commissionDetailId"></td>
                            </tr>
                            <tr>
                                <th>Amount:</th>
                                <td id="commissionDetailAmount"></td>
                            </tr>
                            <tr>
                                <th>Service Type:</th>
                                <td id="commissionDetailServiceType"></td>
                            </tr>
                            <tr>
                                <th>Month:</th>
                                <td id="commissionDetailMonth"></td>
                            </tr>
                            <tr>
                                <th>Status:</th>
                                <td id="commissionDetailStatus"></td>
                            </tr>
                            <tr>
                                <th>Created:</th>
                                <td id="commissionDetailCreated"></td>
                            </tr>
                            <tr>
                                <th>Paid Date:</th>
                                <td id="commissionDetailPaid"></td>
                            </tr>
                        </table>
                    </div>
                    <div class="col-md-6">
                        <h6>Related Information</h6>
                        <table class="table table-sm">
                            <tr>
                                <th>Partner:</th>
                                <td id="commissionDetailPartner"></td>
                            </tr>
                            <tr>
                                <th>Partner Email:</th>
                                <td id="commissionDetailPartnerEmail"></td>
                            </tr>
                            <tr>
                                <th>Company:</th>
                                <td id="commissionDetailCompany"></td>
                            </tr>
                            <tr>
                                <th>Company Status:</th>
                                <td id="commissionDetailCompanyStatus"></td>
                            </tr>
                        </table>
                    </div>
                </div>
                
                <div class="mt-4" id="commissionMetadataSection">
                    <h6>Additional Information</h6>
                    <div class="card bg-light">
                        <div class="card-body">
                            <pre id="commissionDetailMetadata" class="mb-0"></pre>
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                <div id="commissionActionButtons">
                    <button type="button" class="btn btn-success" id="modalMarkPaidBtn">Mark as Paid</button>
                    <button type="button" class="btn btn-danger" id="modalCancelBtn">Cancel Commission</button>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Mark Paid Modal -->
<div class="modal fade" id="markPaidModal" tabindex="-1" aria-labelledby="markPaidModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="markPaidModalLabel">Mark Commission as Paid</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="markPaidForm" action="{{ url_for('commission.mark_commission_paid', commission_id=0) }}" method="post">
                    <input type="hidden" id="markPaidCommissionId" name="commission_id">
                    <p>Are you sure you want to mark this commission of <strong id="markPaidAmount"></strong> for <strong id="markPaidPartner"></strong> as paid?</p>
                    <p>This action cannot be undone.</p>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="submit" form="markPaidForm" class="btn btn-success">Mark as Paid</button>
            </div>
        </div>
    </div>
</div>

<!-- Cancel Commission Modal -->
<div class="modal fade" id="cancelCommissionModal" tabindex="-1" aria-labelledby="cancelCommissionModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="cancelCommissionModalLabel">Cancel Commission</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="cancelCommissionForm" action="{{ url_for('commission.cancel_commission', commission_id=0) }}" method="post">
                    <input type="hidden" id="cancelCommissionId" name="commission_id">
                    <p>Are you sure you want to cancel this commission for <strong id="cancelCommissionPartner"></strong>?</p>
                    <div class="mb-3">
                        <label for="reason" class="form-label">Reason for Cancellation</label>
                        <textarea class="form-control" id="reason" name="reason" rows="3" required></textarea>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                <button type="submit" form="cancelCommissionForm" class="btn btn-danger">Cancel Commission</button>
            </div>
        </div>
    </div>
</div>

<!-- Bulk Pay Modal -->
<div class="modal fade" id="bulkPayModal" tabindex="-1" aria-labelledby="bulkPayModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="bulkPayModalLabel">Pay All Pending Commissions</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <p>Are you sure you want to mark all pending commissions as paid?</p>
                <p>This will affect <strong id="pendingCount">{{ commissions|selectattr('status', 'equalto', 'pending')|list|length }}</strong> commissions totaling <strong id="pendingTotal">${{ "%.2f"|format(commissions|selectattr('status', 'equalto', 'pending')|map(attribute='amount')|sum) }}</strong>.</p>
                <p>This action cannot be undone.</p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-success" id="confirmBulkPayBtn">Mark All as Paid</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
    document.addEventListener("DOMContentLoaded", function() {
        // Initialize tooltips
        var tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'))
        var tooltipList = tooltipTriggerList.map(function (tooltipTriggerEl) {
            return new bootstrap.Tooltip(tooltipTriggerEl)
        });
        
        // Table search functionality
        document.getElementById('searchInput').addEventListener('keyup', function() {
            var input, filter, table, tr, td, i, txtValue;
            input = document.getElementById('searchInput');
            filter = input.value.toUpperCase();
            table = document.getElementById('commissionsTable');
            tr = table.getElementsByTagName('tr');

            for (i = 1; i < tr.length; i++) {
                var found = false;
                var tds = tr[i].getElementsByTagName('td');
                
                for (var j = 0; j < tds.length; j++) {
                    td = tds[j];
                    if (td) {
                        txtValue = td.textContent || td.innerText;
                        if (txtValue.toUpperCase().indexOf(filter) > -1) {
                            found = true;
                            break;
                        }
                    }
                }
                
                if (found) {
                    tr[i].style.display = '';
                } else {
                    tr[i].style.display = 'none';
                }
            }
        });
        
        // Commission chart
        var ctx = document.getElementById('commissionChart').getContext('2d');
        var commissionChart = new Chart(ctx, {
            type: 'pie',
            data: {
                labels: ['Paid', 'Pending', 'Cancelled'],
                datasets: [{
                    data: [
                        {{ commissions|selectattr('status', 'equalto', 'paid')|map(attribute='amount')|sum }},
                        {{ commissions|selectattr('status', 'equalto', 'pending')|map(attribute='amount')|sum }},
                        {{ commissions|selectattr('status', 'equalto', 'cancelled')|map(attribute='amount')|sum }}
                    ],
                    backgroundColor: [
                        '#28a745',
                        '#ffc107',
                        '#dc3545'
                    ],
                    borderWidth: 1
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        position: 'bottom'
                    }
                }
            }
        });
        
        // Mark Paid Modal
        var markPaidModal = document.getElementById('markPaidModal');
        if (markPaidModal) {
            markPaidModal.addEventListener('show.bs.modal', function(event) {
                var button = event.relatedTarget;
                var commissionId = button.getAttribute('data-commission-id');
                var amount = button.getAttribute('data-commission-amount');
                var partnerName = button.getAttribute('data-partner-name');
                
                document.getElementById('markPaidCommissionId').value = commissionId;
                document.getElementById('markPaidAmount').textContent = '$' + parseFloat(amount).toFixed(2);
                document.getElementById('markPaidPartner').textContent = partnerName;
                
                // Update form action
                document.getElementById('markPaidForm').action = "{{ url_for('commission.mark_commission_paid', commission_id=0) }}".replace('0', commissionId);
            });
        }
        
        // Cancel Commission Modal
        var cancelCommissionModal = document.getElementById('cancelCommissionModal');
        if (cancelCommissionModal) {
            cancelCommissionModal.addEventListener('show.bs.modal', function(event) {
                var button = event.relatedTarget;
                var commissionId = button.getAttribute('data-commission-id');
                var partnerName = button.getAttribute('data-partner-name');
                
                document.getElementById('cancelCommissionId').value = commissionId;
                document.getElementById('cancelCommissionPartner').textContent = partnerName;
                
                // Update form action
                document.getElementById('cancelCommissionForm').action = "{{ url_for('commission.cancel_commission', commission_id=0) }}".replace('0', commissionId);
            });
        }
        
        // View Commission Modal
        var viewCommissionModal = document.getElementById('viewCommissionModal');
        if (viewCommissionModal) {
            viewCommissionModal.addEventListener('show.bs.modal', function(event) {
                var button = event.relatedTarget;
                var commissionId = button.getAttribute('data-commission-id');
                
                // TODO: Fetch commission details via AJAX
                // For now, we'll just show a placeholder
                document.getElementById('commissionDetailId').textContent = '#' + commissionId;
                
                // Hide action buttons for now
                document.getElementById('commissionActionButtons').style.display = 'none';
            });
        }
        
        // Process Monthly Button
        document.getElementById('processMonthlyBtn').addEventListener('click', function() {
            // TODO: Send AJAX request to process monthly commissions
            alert('Processing monthly commissions...');
        });
        
        // Export Buttons
        document.getElementById('exportCsvBtn').addEventListener('click', function() {
            // TODO: Export to CSV
            alert('Exporting to CSV...');
        });
        
        document.getElementById('exportExcelBtn').addEventListener('click', function() {
            // TODO: Export to Excel
            alert('Exporting to Excel...');
        });
        
        // Confirm Bulk Pay Button
        document.getElementById('confirmBulkPayBtn').addEventListener('click', function() {
            // TODO: Send AJAX request to mark all pending commissions as paid
            alert('Marking all pending commissions as paid...');
            
            // Close modal
            var modal = bootstrap.Modal.getInstance(document.getElementById('bulkPayModal'));
            modal.hide();
        });
    });
</script>
{% endblock %} 