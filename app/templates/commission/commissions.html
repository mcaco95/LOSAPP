{% extends "base.html" %}

{% block title %}My Commissions{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="row">
        <div class="col-12">
            <div class="card">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h5 class="card-title mb-0">My Commissions</h5>
                    <div>
                        <a href="{{ url_for('commission.dashboard') }}" class="btn btn-sm btn-outline-primary">Back to Dashboard</a>
                    </div>
                </div>
                <div class="card-body">
                    <!-- Filter Controls -->
                    <div class="row mb-4">
                        <div class="col-md-6">
                            <div class="btn-group" role="group">
                                <a href="{{ url_for('commission.commissions') }}" class="btn btn-outline-primary {{ 'active' if not request.args.get('status') }}">All</a>
                                <a href="{{ url_for('commission.commissions', status='pending') }}" class="btn btn-outline-warning {{ 'active' if request.args.get('status') == 'pending' }}">Pending</a>
                                <a href="{{ url_for('commission.commissions', status='paid') }}" class="btn btn-outline-success {{ 'active' if request.args.get('status') == 'paid' }}">Paid</a>
                                <a href="{{ url_for('commission.commissions', status='cancelled') }}" class="btn btn-outline-danger {{ 'active' if request.args.get('status') == 'cancelled' }}">Cancelled</a>
                            </div>
                        </div>
                        <div class="col-md-6 text-end">
                            <div class="input-group" style="max-width: 300px; float: right;">
                                <input type="text" class="form-control" id="searchInput" placeholder="Search commissions...">
                                <button class="btn btn-outline-secondary" type="button">
                                    <i class="fas fa-search"></i>
                                </button>
                            </div>
                        </div>
                    </div>

                    <!-- Commissions Table -->
                    <div class="table-responsive">
                        <table class="table table-hover">
                            <thead>
                                <tr>
                                    <th>Company</th>
                                    <th>Type</th>
                                    <th>Amount</th>
                                    <th>Details</th>
                                    <th>Status</th>
                                    <th>Created</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for commission in commissions %}
                                <tr>
                                    <td>{{ commission.company.name }}</td>
                                    <td>
                                        {% if commission.commission_type == 'safety' %}
                                            <span class="badge bg-primary">Safety Service</span>
                                            {% if commission.is_initial_month %}
                                                <span class="badge bg-info">Initial Month</span>
                                            {% endif %}
                                            {% if commission.commission_metadata.get('network_commission') %}
                                                <span class="badge bg-secondary">Network</span>
                                            {% endif %}
                                        {% else %}
                                            <span class="badge bg-success">Recruitment</span>
                                            {% if commission.commission_metadata.get('network_commission') %}
                                                <span class="badge bg-secondary">Network</span>
                                            {% endif %}
                                        {% endif %}
                                    </td>
                                    <td>${{ "%.2f"|format(commission.amount) }}</td>
                                    <td>
                                        {% if commission.commission_type == 'safety' %}
                                            {% if commission.commission_metadata.get('network_commission') %}
                                                Network commission for referred partner
                                            {% else %}
                                                {{ commission.commission_metadata.get('truck_count', 0) }} trucks @ ${{ "%.2f"|format(commission.commission_metadata.get('price_per_truck', 0)) }}/truck
                                                {% if commission.month_number %}
                                                    <br>Month {{ commission.month_number }}
                                                {% endif %}
                                            {% endif %}
                                        {% else %}
                                            {% if commission.commission_metadata.get('network_commission') %}
                                                Network commission for recruitment
                                            {% else %}
                                                Recruitment commission for completed request
                                            {% endif %}
                                            <br>
                                            Position: {{ commission.commission_metadata.get('position', 'N/A') }}
                                        {% endif %}
                                    </td>
                                    <td>
                                        {% if commission.status == 'pending' %}
                                            <span class="badge bg-warning">Pending</span>
                                        {% elif commission.status == 'paid' %}
                                            <span class="badge bg-success">Paid</span>
                                        {% else %}
                                            <span class="badge bg-secondary">{{ commission.status|title }}</span>
                                        {% endif %}
                                    </td>
                                    <td>{{ commission.created_at.strftime('%Y-%m-%d') }}</td>
                                </tr>
                                {% else %}
                                <tr>
                                    <td colspan="8" class="text-center">
                                        <div class="py-4">
                                            <i class="align-middle fas fa-fw fa-file-invoice-dollar fa-3x mb-3 text-muted"></i>
                                            <h5>No commissions found</h5>
                                            <p class="text-muted">
                                                {% if request.args.get('status') %}
                                                    No {{ request.args.get('status') }} commissions found.
                                                {% else %}
                                                    You don't have any commissions yet.
                                                {% endif %}
                                            </p>
                                        </div>
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>

                    <!-- Pagination -->
                    {% if commissions and commissions|length > 20 %}
                    <nav aria-label="Page navigation" class="mt-4">
                        <ul class="pagination justify-content-center">
                            <li class="page-item disabled">
                                <a class="page-link" href="#" tabindex="-1">Previous</a>
                            </li>
                            <li class="page-item active"><a class="page-link" href="#">1</a></li>
                            <li class="page-item"><a class="page-link" href="#">2</a></li>
                            <li class="page-item"><a class="page-link" href="#">3</a></li>
                            <li class="page-item">
                                <a class="page-link" href="#">Next</a>
                            </li>
                        </ul>
                    </nav>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>

    <!-- Commission Information and Increase Commissions Section -->
    <div class="row mt-4">
        <!-- Commission Information Card -->
        <div class="col-md-6">
            <div class="card border-0 shadow">
                <div class="card-header bg-white">
                    <h5 class="card-title mb-0">Commission Information</h5>
                </div>
                <div class="card-body">
                    <div class="mb-4">
                        <h6 class="fw-bold">Commission Rates</h6>
                        <p class="text-muted">As a commission partner, you earn:</p>
                        <ul>
                            <li>10% recurring commission on monthly payments for the first 2 years</li>
                            <li>2.5% recurring commission on monthly payments from year 3 onwards</li>
                        </ul>
                    </div>
                    
                    <div class="mb-4">
                        <h6 class="fw-bold">Payment Schedule</h6>
                        <p class="text-muted">Commissions are paid monthly on the 15th for all commissions marked as "paid" in the previous month.</p>
                    </div>
                    
                    <div>
                        <h6 class="fw-bold">Commission Status Definitions</h6>
                        <ul class="list-unstyled">
                            <li class="mb-2"><i class="fas fa-clock text-warning me-2"></i> Pending: Commission has been calculated but not yet paid</li>
                            <li class="mb-2"><i class="fas fa-check text-success me-2"></i> Paid: Commission has been paid to your account</li>
                            <li><i class="fas fa-times text-danger me-2"></i> Cancelled: Commission has been cancelled (hover over the info icon to see reason)</li>
                        </ul>
                    </div>
                </div>
            </div>
        </div>

        <!-- Increase Your Commissions Card -->
        <div class="col-md-6">
            <div class="card border-0 shadow">
                <div class="card-header bg-white">
                    <h5 class="card-title mb-0">Increase Your Commissions</h5>
                </div>
                <div class="card-body">
                    <div class="d-flex mb-4">
                        <div class="flex-shrink-0">
                            <i class="align-middle fas fa-fw fa-link fa-2x text-primary"></i>
                        </div>
                        <div class="flex-grow-1 ms-3">
                            <h6 class="fw-bold">Share Your Referral Link</h6>
                            <p class="text-muted small">Share your unique referral link with potential clients to earn commissions when they sign up.</p>
                            <div class="input-group">
                                <input type="text" class="form-control" value="{{ request.host_url }}referral/{{ current_user.unique_link }}" readonly id="referralLink">
                                <button class="btn btn-primary" onclick="navigator.clipboard.writeText('{{ request.host_url }}referral/{{ current_user.unique_link }}'); showCopiedToast();">
                                    <i class="fas fa-copy me-2"></i>Copy
                                </button>
                            </div>
                        </div>
                    </div>

                    <div class="d-flex mb-4">
                        <div class="flex-shrink-0">
                            <i class="align-middle fas fa-fw fa-users fa-2x text-primary"></i>
                        </div>
                        <div class="flex-grow-1 ms-3">
                            <h6 class="fw-bold">Grow Your Partner Network</h6>
                            <p class="text-muted small">Invite others to become commission partners and build your network.</p>
                            <div class="input-group">
                                <input type="text" class="form-control" value="{{ request.host_url }}commission/partners?ref={{ current_user.unique_link }}" readonly id="partnerLink">
                                <button class="btn btn-primary" onclick="navigator.clipboard.writeText('{{ request.host_url }}commission/partners?ref={{ current_user.unique_link }}'); showCopiedToast();">
                                    <i class="fas fa-copy me-2"></i>Copy
                                </button>
                            </div>
                        </div>
                    </div>

                    <div class="d-flex">
                        <div class="flex-shrink-0">
                            <i class="align-middle fas fa-fw fa-arrow-up fa-2x text-primary"></i>
                        </div>
                        <div class="flex-grow-1 ms-3">
                            <h6 class="fw-bold">Promote Professional Plans</h6>
                            <p class="text-muted small">Professional plans earn you higher commissions. Focus on promoting these to maximize your earnings.</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Toast for copy notification -->
<div class="position-fixed bottom-0 end-0 p-3" style="z-index: 11">
    <div id="copyToast" class="toast align-items-center text-white bg-success border-0" role="alert" aria-live="assertive" aria-atomic="true">
        <div class="d-flex">
            <div class="toast-body">
                <i class="fas fa-check-circle me-2"></i> Link copied to clipboard!
            </div>
            <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast" aria-label="Close"></button>
        </div>
    </div>
</div>

{% endblock %}

{% block scripts %}
<script>
    document.addEventListener("DOMContentLoaded", function() {
        // Initialize tooltips
        var tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'))
        var tooltipList = tooltipTriggerList.map(function (tooltipTriggerEl) {
            return new bootstrap.Tooltip(tooltipTriggerEl)
        });
        
        // Table search functionality
        document.getElementById('searchInput').addEventListener('keyup', function() {
            var input, filter, table, tr, td, i, txtValue;
            input = document.getElementById('searchInput');
            filter = input.value.toUpperCase();
            table = document.getElementById('commissionsTable');
            tr = table.getElementsByTagName('tr');

            for (i = 1; i < tr.length; i++) {
                var found = false;
                var tds = tr[i].getElementsByTagName('td');
                
                for (var j = 0; j < tds.length; j++) {
                    td = tds[j];
                    if (td) {
                        txtValue = td.textContent || td.innerText;
                        if (txtValue.toUpperCase().indexOf(filter) > -1) {
                            found = true;
                            break;
                        }
                    }
                }
                
                if (found) {
                    tr[i].style.display = '';
                } else {
                    tr[i].style.display = 'none';
                }
            }
        });
    });

    // Function to show the copied toast
    function showCopiedToast() {
        var toastEl = document.getElementById('copyToast');
        var toast = new bootstrap.Toast(toastEl);
        toast.show();
    }
</script>
{% endblock %} 