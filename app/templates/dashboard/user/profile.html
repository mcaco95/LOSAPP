{% extends "base.html" %}

{% block title %}My Profile{% endblock %}

{% block content %}
<!-- Mobile-optimized profile page with QR code focus -->
<div class="container-fluid px-0">
    <!-- Hero Section with QR Code -->
    <div class="bg-dark text-white position-relative overflow-hidden py-5">
        <div class="position-absolute top-0 start-0 w-100 h-100" style="background: linear-gradient(45deg, #0a1f44 0%, #1a1a1a 100%); opacity: 0.95;"></div>
        <div class="container position-relative">
            <div class="row align-items-center">
                <div class="col-lg-6 text-center text-lg-start mb-4 mb-lg-0">
                    <div class="d-flex align-items-center justify-content-center justify-content-lg-start mb-3">
                        {% if current_user.profile_picture %}
                            <div class="avatar-xl me-3">
                                <img src="{{ url_for('static', filename=current_user.profile_picture) }}" 
                                     class="rounded-circle border border-3 border-white shadow" 
                                     alt="Profile Picture">
                            </div>
                        {% else %}
                            <div class="avatar-xl me-3 bg-primary rounded-circle border border-3 border-white d-flex align-items-center justify-content-center shadow">
                                <span class="fs-2 fw-bold text-white">{{ current_user.name[0] if current_user.name else current_user.email[0] }}</span>
                            </div>
                        {% endif %}
                        <div>
                            <h1 class="display-6 fw-bold mb-0">{{ current_user.name }}</h1>
                            <p class="fs-5 text-white-50">{{ current_user.email }}</p>
                        </div>
                    </div>
                    <p class="lead mb-4">Share your unique referral code with potential clients and earn rewards!</p>
                    <div class="d-grid gap-2 d-md-flex justify-content-md-start">
                        <button class="btn btn-primary btn-lg px-4 me-md-2" onclick="shareQRCode()">
                            <i class="fas fa-share-alt me-2"></i>Share QR Code
                        </button>
                        <button class="btn btn-outline-light btn-lg px-4" onclick="navigator.clipboard.writeText('{{ request.host_url }}r/{{ current_user.unique_link }}'); showCopiedToast();">
                            <i class="fas fa-copy me-2"></i>Copy Link
                        </button>
                    </div>
                </div>
                <div class="col-lg-6">
                    <div class="card border-0 shadow-lg mx-auto" style="max-width: 350px;">
                        <div class="card-body p-0">
                            <div class="p-4 bg-white rounded-top">
                                <img src="{{ qr_code_url }}" alt="Referral QR Code" class="img-fluid rounded">
                            </div>
                            <div class="p-4 bg-light rounded-bottom">
                                <h5 class="card-title mb-2">Your Referral Link</h5>
                                <div class="input-group">
                                    <input type="text" class="form-control" value="{{ request.host_url }}r/{{ current_user.unique_link }}" readonly>
                                    <button class="btn btn-primary" type="button" onclick="navigator.clipboard.writeText('{{ request.host_url }}r/{{ current_user.unique_link }}'); showCopiedToast();">
                                        <i class="fas fa-copy"></i>
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Stats Cards -->
    <div class="container py-5">
        <div class="row g-4">
            <div class="col-md-4">
                <div class="card border-0 shadow-sm h-100 hover-lift">
                    <div class="card-body p-4">
                        <div class="d-flex align-items-center mb-3">
                            <div class="icon-shape icon-md bg-primary text-white rounded-3 me-3">
                                <i class="fas fa-users"></i>
                            </div>
                            <h5 class="mb-0">Referrals</h5>
                        </div>
                        <h2 class="display-5 fw-bold mb-1">{{ current_user.referrals|default(0) }}</h2>
                        <p class="text-muted mb-0">Total referrals sent</p>
                    </div>
                </div>
            </div>
            <div class="col-md-4">
                <div class="card border-0 shadow-sm h-100 hover-lift">
                    <div class="card-body p-4">
                        <div class="d-flex align-items-center mb-3">
                            <div class="icon-shape icon-md bg-success text-white rounded-3 me-3">
                                <i class="fas fa-star"></i>
                            </div>
                            <h5 class="mb-0">Points</h5>
                        </div>
                        <h2 class="display-5 fw-bold mb-1">{{ current_user.points|default(0) }}</h2>
                        <p class="text-muted mb-0">Reward points earned</p>
                    </div>
                </div>
            </div>
            <div class="col-md-4">
                <div class="card border-0 shadow-sm h-100 hover-lift">
                    <div class="card-body p-4">
                        <div class="d-flex align-items-center mb-3">
                            <div class="icon-shape icon-md bg-warning text-white rounded-3 me-3">
                                <i class="fas fa-trophy"></i>
                            </div>
                            <h5 class="mb-0">Rewards</h5>
                        </div>
                        <h2 class="display-5 fw-bold mb-1">{{ current_user.rewards|default(0) }}</h2>
                        <p class="text-muted mb-0">Rewards redeemed</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Tabbed Content -->
    <div class="container pb-5">
        <ul class="nav nav-tabs nav-fill mb-4" id="profileTabs" role="tablist">
            <li class="nav-item" role="presentation">
                <button class="nav-link active" id="account-tab" data-bs-toggle="tab" data-bs-target="#account" type="button" role="tab" aria-controls="account" aria-selected="true">
                    <i class="fas fa-user-circle me-2"></i>Account
                </button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="security-tab" data-bs-toggle="tab" data-bs-target="#security" type="button" role="tab" aria-controls="security" aria-selected="false">
                    <i class="fas fa-shield-alt me-2"></i>Security
                </button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="help-tab" data-bs-toggle="tab" data-bs-target="#help" type="button" role="tab" aria-controls="help" aria-selected="false">
                    <i class="fas fa-question-circle me-2"></i>Help
                </button>
            </li>
        </ul>
        
        <div class="tab-content" id="profileTabsContent">
            <!-- Account Tab -->
            <div class="tab-pane fade show active" id="account" role="tabpanel" aria-labelledby="account-tab">
                <div class="card border-0 shadow-sm">
                    <div class="card-header bg-white py-4">
                        <h5 class="mb-0">Profile Information</h5>
                    </div>
                    <div class="card-body p-4">
                        <div class="row">
                            <div class="col-md-6 mb-4">
                                <div class="form-group">
                                    <label class="form-label fw-bold">Name</label>
                                    <p class="form-control-static">{{ current_user.name }}</p>
                                </div>
                            </div>
                            <div class="col-md-6 mb-4">
                                <div class="form-group">
                                    <label class="form-label fw-bold">Email</label>
                                    <p class="form-control-static">{{ current_user.email }}</p>
                                </div>
                            </div>
                            <div class="col-md-6 mb-4">
                                <div class="form-group">
                                    <label class="form-label fw-bold">Member Since</label>
                                    <p class="form-control-static">{{ current_user.created_at.strftime('%B %d, %Y') if current_user.created_at else 'N/A' }}</p>
                                </div>
                            </div>
                            <div class="col-md-6 mb-4">
                                <div class="form-group">
                                    <label class="form-label fw-bold">Referral ID</label>
                                    <p class="form-control-static">{{ current_user.unique_link }}</p>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Profile Picture Update -->
                        <div class="mt-3">
                            <h5 class="mb-3">Update Profile Picture</h5>
                            <form action="{{ url_for('users.update_profile_picture') }}" method="POST" enctype="multipart/form-data">
                                {{ picture_form.csrf_token }}
                                <div class="input-group mb-3">
                                    {{ picture_form.picture(class="form-control") }}
                                    <button class="btn btn-primary" type="submit">Upload</button>
                                </div>
                                <div class="form-text">JPG, GIF or PNG. Max size of 800K</div>
                            </form>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Security Tab -->
            <div class="tab-pane fade" id="security" role="tabpanel" aria-labelledby="security-tab">
                <div class="card border-0 shadow-sm">
                    <div class="card-header bg-white py-4">
                        <h5 class="mb-0">Change Password</h5>
                    </div>
                    <div class="card-body p-4">
                        <form action="{{ url_for('users.change_password') }}" method="POST">
                            {{ password_form.csrf_token }}
                            <div class="mb-3">
                                <label for="current_password" class="form-label">Current Password</label>
                                {{ password_form.current_password(class="form-control", placeholder="Enter your current password") }}
                            </div>
                            <div class="row">
                                <div class="col-md-6 mb-3">
                                    <label for="new_password" class="form-label">New Password</label>
                                    {{ password_form.new_password(class="form-control", placeholder="Enter new password") }}
                                </div>
                                <div class="col-md-6 mb-3">
                                    <label for="confirm_password" class="form-label">Confirm New Password</label>
                                    {{ password_form.confirm_password(class="form-control", placeholder="Confirm new password") }}
                                </div>
                            </div>
                            <button type="submit" class="btn btn-primary">Update Password</button>
                        </form>
                    </div>
                </div>
            </div>
            
            <!-- Help Tab -->
            <div class="tab-pane fade" id="help" role="tabpanel" aria-labelledby="help-tab">
                <div class="card border-0 shadow-sm">
                    <div class="card-header bg-white py-4">
                        <h5 class="mb-0">Need Help?</h5>
                    </div>
                    <div class="card-body p-4">
                        <div class="accordion" id="helpAccordion">
                            <div class="accordion-item">
                                <h2 class="accordion-header" id="headingOne">
                                    <button class="accordion-button" type="button" data-bs-toggle="collapse" data-bs-target="#collapseOne" aria-expanded="true" aria-controls="collapseOne">
                                        How do I share my referral code?
                                    </button>
                                </h2>
                                <div id="collapseOne" class="accordion-collapse collapse show" aria-labelledby="headingOne" data-bs-parent="#helpAccordion">
                                    <div class="accordion-body">
                                        <p>You can share your referral code in several ways:</p>
                                        <ul>
                                            <li>Click the "Share QR Code" button to share directly to social media or messaging apps</li>
                                            <li>Copy your referral link and share it via email, text, or social media</li>
                                            <li>Show your QR code to someone in person so they can scan it with their phone</li>
                                        </ul>
                                    </div>
                                </div>
                            </div>
                            <div class="accordion-item">
                                <h2 class="accordion-header" id="headingTwo">
                                    <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseTwo" aria-expanded="false" aria-controls="collapseTwo">
                                        How do I earn points?
                                    </button>
                                </h2>
                                <div id="collapseTwo" class="accordion-collapse collapse" aria-labelledby="headingTwo" data-bs-parent="#helpAccordion">
                                    <div class="accordion-body">
                                        <p>You earn points when your referrals complete specific actions:</p>
                                        <ul>
                                            <li><strong>2 points</strong> - When someone clicks your referral link</li>
                                            <li><strong>5 points</strong> - When a referral signs up</li>
                                            <li><strong>15 points</strong> - When a referral completes their profile</li>
                                            <li><strong>50 points</strong> - When a referral becomes a customer</li>
                                        </ul>
                                    </div>
                                </div>
                            </div>
                            <div class="accordion-item">
                                <h2 class="accordion-header" id="headingThree">
                                    <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseThree" aria-expanded="false" aria-controls="collapseThree">
                                        How do I redeem rewards?
                                    </button>
                                </h2>
                                <div id="collapseThree" class="accordion-collapse collapse" aria-labelledby="headingThree" data-bs-parent="#helpAccordion">
                                    <div class="accordion-body">
                                        <p>Visit the Rewards section in your dashboard to see available rewards and redeem your points. Rewards include gift cards, merchandise, and cash payouts depending on your point balance.</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="mt-4 text-center">
                            <p class="mb-3">Still have questions? Contact our support team.</p>
                            <a href="mailto:support@logisticsonesource.com" class="btn btn-outline-primary">
                                <i class="fas fa-envelope me-2"></i>Email Support
                            </a>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Toast for copy notification -->
<div class="position-fixed bottom-0 end-0 p-3" style="z-index: 11">
    <div id="copyToast" class="toast align-items-center text-white bg-success border-0" role="alert" aria-live="assertive" aria-atomic="true">
        <div class="d-flex">
            <div class="toast-body">
                <i class="fas fa-check-circle me-2"></i> Link copied to clipboard!
            </div>
            <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast" aria-label="Close"></button>
        </div>
    </div>
</div>

<!-- Add Font Awesome for icons -->
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css">

<script>
    // Function to show the copied toast
    function showCopiedToast() {
        var toastEl = document.getElementById('copyToast');
        var toast = new bootstrap.Toast(toastEl);
        toast.show();
    }
    
    // Function to share QR code
    function shareQRCode() {
        if (navigator.share) {
            navigator.share({
                title: 'My LOS Referral Code',
                text: 'Use my referral link to sign up for Logistics One Source!',
                url: '{{ request.host_url }}r/{{ current_user.unique_link }}'
            })
            .catch(error => console.log('Error sharing:', error));
        } else {
            // Fallback for browsers that don't support Web Share API
            navigator.clipboard.writeText('{{ request.host_url }}r/{{ current_user.unique_link }}');
            showCopiedToast();
        }
    }
    
    // Add hover effect for cards
    document.addEventListener('DOMContentLoaded', function() {
        // Add custom hover class for cards
        const style = document.createElement('style');
        style.textContent = `
            .hover-lift {
                transition: transform 0.2s ease-in-out, box-shadow 0.2s ease-in-out;
            }
            .hover-lift:hover {
                transform: translateY(-5px);
                box-shadow: 0 1rem 3rem rgba(0,0,0,.175)!important;
            }
        `;
        document.head.appendChild(style);
    });
</script>
{% endblock %}
