{% extends "base.html" %}

{% block title %}{{ company.name }} - Company Details{% endblock %}

{% block extra_css %}
<style>
    :root {
        --primary: #4F46E5;
        --primary-light: #818CF8;
        --success: #10B981;
        --warning: #F59E0B;
        --danger: #EF4444;
        --info: #3B82F6;
        --gray-50: #F9FAFB;
        --gray-100: #F3F4F6;
        --gray-200: #E5E7EB;
        --gray-300: #D1D5DB;
        --gray-400: #9CA3AF;
        --gray-500: #6B7280;
        --gray-600: #4B5563;
        --gray-700: #374151;
        --gray-800: #1F2937;
        --gray-900: #111827;
    }

    .company-header {
        background: linear-gradient(to right, var(--gray-800), var(--gray-900));
        border-bottom: none;
        padding: 2rem 0;
        margin-bottom: 2rem;
        color: white;
        position: relative;
        overflow: visible;
    }

    .company-header::before {
        content: '';
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: url('data:image/svg+xml,<svg width="20" height="20" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg"><rect width="20" height="20" fill="none"/><circle cx="3" cy="3" r="1" fill="rgba(255,255,255,0.1)"/></svg>') repeat;
        opacity: 0.3;
    }

    .company-header h1 {
        font-weight: 700;
        letter-spacing: -0.025em;
        color: white;
    }

    .company-header .text-muted {
        color: rgba(255, 255, 255, 0.7) !important;
    }

    .header-status-badge {
        padding: 0.5rem 1rem;
        border-radius: 9999px;
        font-size: 0.875rem;
        font-weight: 500;
        display: inline-flex;
        align-items: center;
        gap: 0.5rem;
        cursor: pointer;
        transition: all 0.2s ease;
        position: relative;
    }

    .dropdown {
        position: relative;
        z-index: 1050;
    }

    .dropdown-menu {
        position: absolute;
        z-index: 1060;
        border: 1px solid var(--gray-200);
        box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1);
        border-radius: 0.75rem;
        padding: 0.5rem;
        min-width: 200px;
        background: white;
        margin-top: 0.5rem;
        transform-origin: top;
        animation: dropdownFade 0.2s ease;
    }

    @keyframes dropdownFade {
        from {
            opacity: 0;
            transform: translateY(-10px);
        }
        to {
            opacity: 1;
            transform: translateY(0);
        }
    }

    .dropdown-item {
        padding: 0.75rem 1rem;
        border-radius: 0.5rem;
        font-size: 0.875rem;
        color: var(--gray-700);
        transition: all 0.2s ease;
    }

    .dropdown-item:hover {
        background-color: var(--gray-50);
        color: var(--gray-900);
    }

    .header-status-badge:hover {
        transform: translateY(-1px);
    }

    .header-status-badge::before {
        content: '';
        width: 0.5rem;
        height: 0.5rem;
        border-radius: 50%;
        background: currentColor;
        box-shadow: 0 0 0 2px rgba(0, 0, 0, 0.1);
    }

    .header-status-referral_form_completed {
        background-color: #60A5FA;
        color: white;
    }

    .header-status-filled_out_form {
        background-color: #818CF8;
        color: white;
    }

    .header-status-demo_scheduled {
        background-color: #FCD34D;
        color: #92400E;
    }

    .header-status-demo_completed {
        background-color: #34D399;
        color: white;
    }

    .header-status-client_renewed {
        background-color: #38BDF8;
        color: white;
    }

    .header-status-client_signed_up {
        background-color: #4ADE80;
        color: white;
    }

    .service-card {
        background: white;
        border-radius: 1rem;
        box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
        transition: all 0.3s ease;
        border: 1px solid var(--gray-200);
    }

    .service-card:hover {
        transform: translateY(-2px);
        box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
    }

    .recruitment-table {
        background: white;
        border-radius: 1rem;
        box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
        overflow: hidden;
        border: 1px solid var(--gray-200);
    }

    .recruitment-table th {
        background: var(--gray-50);
        font-weight: 600;
        color: var(--gray-700);
        padding: 1rem;
        font-size: 0.875rem;
        text-transform: uppercase;
        letter-spacing: 0.05em;
        border-bottom: 2px solid var(--gray-200);
    }

    .recruitment-table td {
        padding: 1rem;
        vertical-align: middle;
        border-bottom: 1px solid var(--gray-200);
    }

    .recruitment-table tr:hover {
        background-color: var(--gray-50);
    }

    .status-badge {
        padding: 0.5rem 1rem;
        border-radius: 9999px;
        font-size: 0.875rem;
        font-weight: 500;
        display: inline-flex;
        align-items: center;
        gap: 0.5rem;
        text-transform: capitalize;
    }

    .status-badge::before {
        content: '';
        width: 0.5rem;
        height: 0.5rem;
        border-radius: 50%;
        background: currentColor;
        box-shadow: 0 0 0 2px rgba(255, 255, 255, 0.8);
    }

    .status-badge-new {
        background-color: #EBF5FF;
        color: #2563EB;
    }

    .status-badge-in_progress {
        background-color: #FEF3C7;
        color: #D97706;
    }

    .status-badge-completed {
        background-color: #D1FAE5;
        color: #059669;
    }

    .charge-amount {
        font-family: 'SF Mono', 'Monaco', 'Inconsolata', monospace;
        font-weight: 600;
        color: var(--gray-800);
        background: var(--gray-100);
        padding: 0.25rem 0.75rem;
        border-radius: 0.5rem;
        font-size: 0.875rem;
    }

    .date-cell {
        color: var(--gray-600);
        font-size: 0.875rem;
        display: flex;
        align-items: center;
        gap: 0.5rem;
    }

    .date-cell i {
        color: var(--gray-400);
        font-size: 0.875rem;
    }

    .action-button {
        padding: 0.5rem 1rem;
        border-radius: 0.5rem;
        font-size: 0.875rem;
        font-weight: 500;
        transition: all 0.2s ease;
        border: none;
        background: var(--primary);
        color: white;
    }

    .action-button:hover {
        transform: translateY(-1px);
        box-shadow: 0 4px 6px rgba(79, 70, 229, 0.2);
        background: var(--primary-light);
    }

    .add-request-btn {
        background: var(--primary);
        color: white;
        padding: 0.75rem 1.5rem;
        border-radius: 0.75rem;
        font-weight: 500;
        transition: all 0.2s ease;
        border: none;
        display: inline-flex;
        align-items: center;
        gap: 0.5rem;
    }

    .add-request-btn:hover {
        background: var(--primary-light);
        transform: translateY(-1px);
        box-shadow: 0 4px 6px rgba(79, 70, 229, 0.2);
    }

    .service-toggle {
        width: 3.5rem;
        height: 2rem;
        background-color: var(--gray-200);
        border-radius: 2rem;
        padding: 0.25rem;
        position: relative;
        cursor: pointer;
        transition: all 0.3s ease;
    }

    .service-toggle.active {
        background-color: var(--success);
    }

    .toggle-handle {
        width: 1.5rem;
        height: 1.5rem;
        background-color: white;
        border-radius: 50%;
        position: absolute;
        left: 0.25rem;
        transition: all 0.3s ease;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
    }

    .service-toggle.active .toggle-handle {
        left: 1.75rem;
    }

    .section-header {
        display: flex;
        align-items: center;
        gap: 1rem;
        margin-bottom: 1.5rem;
        padding-bottom: 1rem;
        border-bottom: 2px solid var(--gray-200);
    }

    .section-header h5 {
        font-weight: 600;
        color: var(--gray-900);
        margin: 0;
    }

    .section-header .badge {
        background: var(--primary);
        color: white;
        padding: 0.25rem 0.75rem;
        border-radius: 9999px;
        font-size: 0.875rem;
        font-weight: 500;
    }

    .modal-content {
        border-radius: 1rem;
        border: none;
        box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
    }

    .modal-header {
        border-bottom: 2px solid var(--gray-200);
        padding: 1.5rem;
    }

    .modal-body {
        padding: 1.5rem;
    }

    .modal-footer {
        border-top: 2px solid var(--gray-200);
        padding: 1.5rem;
    }

    .form-label {
        font-weight: 500;
        color: var(--gray-700);
        margin-bottom: 0.5rem;
    }

    .form-control {
        border-radius: 0.5rem;
        border: 2px solid var(--gray-300);
        padding: 0.75rem 1rem;
        transition: all 0.2s ease;
    }

    .form-control:focus {
        border-color: var(--primary);
        box-shadow: 0 0 0 3px rgba(79, 70, 229, 0.1);
    }

    .input-group-text {
        background: var(--gray-100);
        border: 2px solid var(--gray-300);
        border-right: none;
        color: var(--gray-600);
        font-weight: 500;
    }

    .header-btn {
        font-weight: 500;
        padding: 0.5rem 1rem;
        border-radius: 0.5rem;
        transition: all 0.2s ease;
        z-index: 10;
        position: relative;
    }

    .header-btn:hover {
        transform: translateY(-1px);
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
    }

    .btn-outline-light {
        border: 2px solid rgba(255, 255, 255, 0.5);
    }

    .btn-outline-light:hover {
        border-color: white;
        background: rgba(255, 255, 255, 0.1);
    }

    .btn-light {
        background: white;
        color: var(--gray-800);
        border: none;
    }

    .btn-light:hover {
        background: var(--gray-50);
        color: var(--gray-900);
    }

    .timeline {
        position: relative;
        padding-left: 3rem;
    }

    .timeline::before {
        content: '';
        position: absolute;
        left: 1rem;
        top: 0;
        bottom: 0;
        width: 2px;
        background: var(--gray-200);
    }

    .timeline-item {
        position: relative;
    }

    .timeline-icon {
        width: 2rem;
        height: 2rem;
        background: white;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        border: 2px solid var(--gray-200);
        z-index: 1;
    }

    .timeline-icon i {
        font-size: 1rem;
    }
</style>
{% endblock %}

{% block content %}
<div class="company-header">
    <div class="container-fluid">
        <div class="d-flex justify-content-between align-items-center">
            <div>
                <div class="d-flex align-items-center gap-3">
                    <h1 class="h3 mb-0">{{ company.name }}</h1>
                    <div class="dropdown">
                        <span class="header-status-badge header-status-{{ company.status }}" data-bs-toggle="dropdown" aria-expanded="false">
                            {{ company.status|replace('_', ' ')|title }}
                        </span>
                        <ul class="dropdown-menu">
                            <li><a class="dropdown-item" href="#" onclick="updateCompanyStatus('referral_form_completed')">Referral form completed</a></li>
                            <li><a class="dropdown-item" href="#" onclick="updateCompanyStatus('filled_out_form')">Filled out form</a></li>
                            <li><a class="dropdown-item" href="#" onclick="updateCompanyStatus('demo_scheduled')">Demo scheduled</a></li>
                            <li><a class="dropdown-item" href="#" onclick="updateCompanyStatus('demo_completed')">Demo completed</a></li>
                            <li><a class="dropdown-item" href="#" onclick="updateCompanyStatus('client_renewed')">Client renewed</a></li>
                            <li><a class="dropdown-item" href="#" onclick="updateCompanyStatus('client_signed_up')">Client signed up</a></li>
                        </ul>
                    </div>
                </div>
                <p class="text-muted mb-0">Company ID: {{ company.id }}</p>
            </div>
            <div>
                <a href="{{ url_for('main.admin_companies') }}" class="btn btn-light header-btn">
                    <i class="fas fa-arrow-left me-2"></i>Back to Companies
                </a>
            </div>
        </div>
    </div>
</div>

<div class="container-fluid">
    <div class="row g-4">
        <!-- Company Information -->
        <div class="col-12">
            <div class="service-card p-4">
                <div class="d-flex justify-content-between align-items-center mb-4">
                    <h5 class="mb-0">Company Information</h5>
                    <button class="btn btn-light header-btn" data-bs-toggle="modal" data-bs-target="#editCompanyModal">
                        <i class="fas fa-edit me-2"></i>Edit
                    </button>
                </div>
                
                <div class="row">
                    <div class="col-md-3">
                        <div class="mb-3">
                            <label class="text-muted d-block mb-1">Contact Name</label>
                            <div class="fw-medium">{{ company.contact_name }}</div>
                        </div>
                    </div>
                    
                    <div class="col-md-3">
                        <div class="mb-3">
                            <label class="text-muted d-block mb-1">Email</label>
                            <div class="fw-medium">{{ company.email }}</div>
                        </div>
                    </div>
                    
                    <div class="col-md-3">
                        <div class="mb-3">
                            <label class="text-muted d-block mb-1">Phone</label>
                            <div class="fw-medium">{{ company.phone or 'Not provided' }}</div>
                        </div>
                    </div>
                    
                    <div class="col-md-3">
                        <div class="mb-3">
                            <label class="text-muted d-block mb-1">Created</label>
                            <div class="fw-medium">{{ company.created_at.strftime('%B %d, %Y') }}</div>
                        </div>
                    </div>

                    <div class="col-md-3">
                        <div class="mb-3">
                            <label class="text-muted d-block mb-1">Partner</label>
                            <div class="fw-medium">{{ company.user.name }}</div>
                            <div class="text-muted small">{{ company.user.email }}</div>
                        </div>
                    </div>

                    <div class="col-md-3">
                        <div class="mb-3">
                            <label class="text-muted d-block mb-1">Payment Date</label>
                            <div class="fw-medium">{{ company.payment_date.strftime('%B %d, %Y') if company.payment_date else 'Not set' }}</div>
                        </div>
                    </div>

                    <div class="col-md-3">
                        <div class="mb-3">
                            <label class="text-muted d-block mb-1">Service Type</label>
                            <div class="fw-medium">{{ company.service_display }}</div>
                        </div>
                    </div>

                    <div class="col-md-3">
                        <div class="mb-3">
                            <label class="text-muted d-block mb-1">Additional Info</label>
                            <div class="fw-medium">{{ company.additional_info or 'None' }}</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Safety Management -->
        <div class="col-md-6">
            <div class="service-card p-4 h-100">
                <div class="d-flex justify-content-between align-items-center mb-4">
                    <div>
                        <div class="d-flex align-items-center gap-3">
                            <h5 class="mb-1">Safety Management</h5>
                            <div class="service-toggle {% if company.safety_status == 'active' %}active{% endif %}" 
                                 id="safetyToggle" 
                                 onclick="toggleService('safety')">
                                <div class="toggle-handle"></div>
                            </div>
                        </div>
                        <p class="text-muted mb-0">Manage fleet safety service configuration</p>
                    </div>
                </div>

                <div class="mb-4">
                    <button class="btn btn-light header-btn w-100" data-bs-toggle="modal" data-bs-target="#editSafetyModal">
                        <i class="fas fa-edit me-2"></i>Edit Configuration
                    </button>
                </div>

                <div class="row g-3">
                    <div class="col-12">
                        <div class="border rounded-3 p-3">
                            <label class="text-muted d-block mb-2">Number of Trucks</label>
                            <div class="d-flex align-items-center">
                                <i class="fas fa-truck me-2 text-primary"></i>
                                <span class="h4 mb-0" id="truckCount">{{ company.truck_count or 0 }}</span>
                            </div>
                        </div>
                    </div>
                    <div class="col-12">
                        <div class="border rounded-3 p-3">
                            <label class="text-muted d-block mb-2">Price per Truck</label>
                            <div class="d-flex align-items-center">
                                <i class="fas fa-tag me-2 text-warning"></i>
                                <span class="h4 mb-0" id="pricePerTruck">${{ "%.2f"|format(company.price_per_truck or 0) }}</span>
                            </div>
                        </div>
                    </div>
                    <div class="col-12">
                        <div class="border rounded-3 p-3">
                            <label class="text-muted d-block mb-2">Monthly Charge</label>
                            <div class="d-flex align-items-center">
                                <i class="fas fa-dollar-sign me-2 text-success"></i>
                                <span class="h4 mb-0" id="monthlyCharge">${{ "%.2f"|format((company.truck_count or 0) * (company.price_per_truck or 0)) }}</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Recruitment Management -->
        <div class="col-md-6">
            <div class="service-card p-4 h-100">
                <div class="d-flex justify-content-between align-items-center mb-4">
                    <div>
                        <div class="d-flex align-items-center gap-3">
                            <h5 class="mb-1">Recruitment Management</h5>
                            <div class="service-toggle {% if company.recruitment_status == 'active' %}active{% endif %}" 
                                 id="recruitmentToggle" 
                                 onclick="toggleService('recruitment')">
                                <div class="toggle-handle"></div>
                            </div>
                        </div>
                        <p class="text-muted mb-0">Track and manage recruitment requests</p>
                    </div>
                </div>

                <div class="mb-4">
                    <button class="btn btn-primary w-100" id="addRequestBtn">
                        <i class="fas fa-plus me-2"></i>Add Request
                    </button>
                </div>

                <div class="recruitment-table table-responsive">
                    <table class="table mb-0">
                        <thead>
                            <tr>
                                <th style="width: 20%">Role</th>
                                <th style="width: 15%">Status</th>
                                <th style="width: 15%">Charge</th>
                                <th style="width: 15%">Created</th>
                                <th style="width: 15%">Updated</th>
                                <th style="width: 20%">Actions</th>
                            </tr>
                        </thead>
                        <tbody id="requestsTable">
                            <tr>
                                <td colspan="6" class="text-center py-4">Loading requests...</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- Updates Section -->
        <div class="col-12">
            <div class="service-card p-4">
                <h5 class="mb-4">Updates</h5>
                <div class="timeline">
                    {% if company.company_metadata and company.company_metadata.status_history %}
                        {% for entry in company.company_metadata.status_history|reverse %}
                            <div class="timeline-item mb-4">
                                <div class="d-flex align-items-center mb-2">
                                    <div class="timeline-icon me-3">
                                        {% if entry.to == 'client_signed_up' %}
                                            <i class="fas fa-check-circle text-success"></i>
                                        {% elif entry.to == 'demo_scheduled' %}
                                            <i class="fas fa-calendar text-warning"></i>
                                        {% elif entry.to == 'demo_completed' %}
                                            <i class="fas fa-calendar-check text-info"></i>
                                        {% elif entry.to == 'client_renewed' %}
                                            <i class="fas fa-sync text-primary"></i>
                                        {% else %}
                                            <i class="fas fa-circle text-secondary"></i>
                                        {% endif %}
                                    </div>
                                    <div>
                                        <h6 class="mb-0">Status changed to {{ company.get_status_display(entry.to) }}</h6>
                                        <small class="text-muted">{{ entry.timestamp[:19]|replace('T', ' ') }}</small>
                                    </div>
                                    {% if entry.get('points_awarded', 0) > 0 %}
                                        <span class="ms-auto badge bg-success">
                                            <i class="fas fa-star me-1"></i>{{ entry.points_awarded }} points
                                        </span>
                                    {% endif %}
                                </div>
                            </div>
                        {% endfor %}
                    {% endif %}

                    {% if company.recruitment_requests and company.recruitment_requests.requests %}
                        {% for request in company.recruitment_requests.requests %}
                            <div class="timeline-item mb-4">
                                <div class="d-flex align-items-center mb-2">
                                    <div class="timeline-icon me-3">
                                        <i class="fas fa-user-tie text-primary"></i>
                                    </div>
                                    <div>
                                        <h6 class="mb-0">Recruitment Request: {{ request.role }}</h6>
                                        <small class="text-muted">{{ request.created_at[:19]|replace('T', ' ') }}</small>
                                        <div class="mt-1">
                                            <span class="badge bg-{{ 'success' if request.status == 'completed' else 'warning' if request.status == 'in_progress' else 'info' }}">
                                                {{ request.status|replace('_', ' ')|title }}
                                            </span>
                                            <span class="ms-2 text-muted">Charge: ${{ "%.2f"|format(request.charge) }}</span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        {% endfor %}
                    {% endif %}

                    {% if company.safety_status == 'active' %}
                        <div class="timeline-item mb-4">
                            <div class="d-flex align-items-center mb-2">
                                <div class="timeline-icon me-3">
                                    <i class="fas fa-shield-alt text-success"></i>
                                </div>
                                <div>
                                    <h6 class="mb-0">Safety Service Activated</h6>
                                    <small class="text-muted">Monthly Charge: ${{ "%.2f"|format((company.truck_count or 0) * (company.price_per_truck or 0)) }}</small>
                                    <div class="mt-1">
                                        <span class="badge bg-info me-2">{{ company.truck_count or 0 }} Trucks</span>
                                        <span class="badge bg-info">${{ "%.2f"|format(company.price_per_truck or 0) }}/truck</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Add/Edit Request Modal -->
<div class="modal fade" id="requestModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="modalTitle">Add Recruitment Request</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="requestForm">
                    <input type="hidden" name="requestId">
                    <div class="mb-3">
                        <label class="form-label">Role*</label>
                        <input type="text" class="form-control" name="position" required>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Charge Amount (USD)*</label>
                        <div class="input-group">
                            <span class="input-group-text">$</span>
                            <input type="number" class="form-control" name="charge" required min="0" step="0.01">
                        </div>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Status</label>
                        <select class="form-select" name="status" required>
                            <option value="new">New</option>
                            <option value="in_progress">In Progress</option>
                            <option value="completed">Completed</option>
                        </select>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Notes</label>
                        <textarea class="form-control" name="notes" rows="3"></textarea>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-danger me-auto d-none" id="deleteRequest">
                    Delete Request
                </button>
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" id="saveRequest">Save Request</button>
            </div>
        </div>
    </div>
</div>

<!-- Add Edit Company Modal -->
<div class="modal fade" id="editCompanyModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Edit Company</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="editCompanyForm">
                    <div class="mb-3">
                        <label class="form-label">Company Name*</label>
                        <input type="text" class="form-control" name="name" value="{{ company.name }}" required>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Contact Name</label>
                        <input type="text" class="form-control" name="contact_name" value="{{ company.contact_name }}">
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Email</label>
                        <input type="email" class="form-control" name="email" value="{{ company.email }}">
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Phone</label>
                        <input type="tel" class="form-control" name="phone" value="{{ company.phone }}">
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Additional Information</label>
                        <textarea class="form-control" name="additional_info" rows="3">{{ company.additional_info }}</textarea>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" id="saveCompanyEdit">Save Changes</button>
            </div>
        </div>
    </div>
</div>

<!-- Add Safety Configuration Modal -->
<div class="modal fade" id="editSafetyModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Edit Safety Configuration</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="editSafetyForm">
                    <div class="mb-3">
                        <label class="form-label">Number of Trucks*</label>
                        <input type="number" class="form-control" name="truck_count" value="{{ company.truck_count or 0 }}" required min="0" step="1">
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Price per Truck (USD)*</label>
                        <div class="input-group">
                            <span class="input-group-text">$</span>
                            <input type="number" class="form-control" name="price_per_truck" value="{{ company.price_per_truck or 0 }}" required min="0" step="0.01">
                        </div>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Calculated Monthly Charge</label>
                        <div class="input-group">
                            <span class="input-group-text">$</span>
                            <input type="text" class="form-control" id="calculatedCharge" readonly>
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" id="saveSafetyConfig">Save Changes</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    const companyId = {{ company.id }};
    
    // Initialize modals
    const requestModal = new bootstrap.Modal(document.getElementById('requestModal'));
    
    // Add meta tag for CSRF if not present
    if (!document.querySelector('meta[name="csrf-token"]')) {
        const meta = document.createElement('meta');
        meta.name = 'csrf-token';
        meta.content = '{{ csrf_token() }}';
        document.head.appendChild(meta);
    }

    // Toggle Service Status
    window.toggleService = function(service) {
        const toggle = document.getElementById(`${service}Toggle`);
        const currentStatus = toggle.classList.contains('active') ? 'inactive' : 'active';
        
        fetch(`/api/v1/company/${companyId}/service-status`, {
            method: 'PUT',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRF-Token': document.querySelector('meta[name="csrf-token"]').content
            },
            body: JSON.stringify({
                service: service,
                status: currentStatus
            })
        })
        .then(response => {
            if (!response.ok) throw new Error('Failed to update service status');
            return response.json();
        })
        .then(data => {
            if (!data.success) throw new Error(data.message || 'Failed to update service status');
            
            toggle.classList.toggle('active');
            Toast.success(`${service.charAt(0).toUpperCase() + service.slice(1)} service ${currentStatus}`);
        })
        .catch(error => {
            console.error('Error:', error);
            Toast.error(error.message);
        });
    };

    // Safety Configuration Form
    const editSafetyForm = document.getElementById('editSafetyForm');
    
    // Calculate monthly charge when inputs change
    editSafetyForm.addEventListener('input', function(e) {
        if (e.target.name === 'truck_count' || e.target.name === 'price_per_truck') {
            const truckCount = parseFloat(editSafetyForm.elements['truck_count'].value) || 0;
            const pricePerTruck = parseFloat(editSafetyForm.elements['price_per_truck'].value) || 0;
            const monthlyCharge = truckCount * pricePerTruck;
            document.getElementById('calculatedCharge').value = monthlyCharge.toFixed(2);
        }
    });

    // Save Safety Configuration
    document.getElementById('saveSafetyConfig').addEventListener('click', function() {
        const formData = new FormData(editSafetyForm);
        const safetyData = {
            truck_count: parseInt(formData.get('truck_count')),
            price_per_truck: parseFloat(formData.get('price_per_truck'))
        };

        fetch(`/api/v1/company/${companyId}/safety-config`, {
            method: 'PUT',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRF-Token': document.querySelector('meta[name="csrf-token"]').content
            },
            body: JSON.stringify(safetyData)
        })
        .then(response => {
            if (!response.ok) throw new Error('Failed to update safety configuration');
            return response.json();
        })
        .then(data => {
            if (!data.success) throw new Error(data.message || 'Failed to update safety configuration');
            
            // Update the displayed values
            document.getElementById('truckCount').textContent = safetyData.truck_count;
            document.getElementById('pricePerTruck').textContent = '$' + safetyData.price_per_truck.toFixed(2);
            document.getElementById('monthlyCharge').textContent = '$' + (safetyData.truck_count * safetyData.price_per_truck).toFixed(2);
            
            // Close the modal
            bootstrap.Modal.getInstance(document.getElementById('editSafetyModal')).hide();
            
            // Show success message
            Toast.success('Safety configuration updated successfully');
        })
        .catch(error => {
            console.error('Error:', error);
            Toast.error(error.message);
        });
    });

    // Load Requests
    function loadRequests() {
        const table = document.getElementById('requestsTable');
        table.innerHTML = '<tr><td colspan="6" class="text-center py-4">Loading requests...</td></tr>';

        fetch(`/api/v1/company/${companyId}/recruitment-requests`)
            .then(response => {
                if (!response.ok) throw new Error('Failed to load requests');
                return response.json();
            })
            .then(data => {
                if (!data.success || !data.requests) throw new Error('Invalid data received');
                
                if (data.requests.length === 0) {
                    table.innerHTML = '<tr><td colspan="6" class="text-center py-4">No recruitment requests found</td></tr>';
                    return;
                }

                table.innerHTML = data.requests.map((request, index) => `
                    <tr>
                        <td class="align-middle">
                            <div class="fw-medium text-gray-900">${request.role || 'N/A'}</div>
                            ${request.notes ? `<div class="text-gray-500 text-sm mt-1">${request.notes}</div>` : ''}
                        </td>
                        <td class="align-middle">
                            <span class="status-badge status-badge-${request.status || 'new'}">
                                ${(request.status || 'new').replace('_', ' ').charAt(0).toUpperCase() + (request.status || 'new').slice(1)}
                            </span>
                        </td>
                        <td class="align-middle">
                            <span class="charge-amount">$${(typeof request.charge === 'number' ? request.charge.toFixed(2) : '0.00')}</span>
                        </td>
                        <td class="align-middle">
                            <span class="date-cell">
                                <i class="far fa-calendar"></i>
                                ${formatDate(request.created_at)}
                            </span>
                        </td>
                        <td class="align-middle">
                            <span class="date-cell">
                                <i class="far fa-clock"></i>
                                ${formatDate(request.updated_at)}
                            </span>
                        </td>
                        <td class="align-middle">
                            <div class="d-flex gap-2">
                                <button class="btn btn-sm btn-primary action-button" onclick="editRequest(${index})">
                                    <i class="fas fa-edit me-1"></i>Edit
                                </button>
                            </div>
                        </td>
                    </tr>
                `).join('');
            })
            .catch(error => {
                console.error('Error:', error);
                table.innerHTML = `<tr><td colspan="6" class="text-center py-4 text-danger">Error: ${error.message}</td></tr>`;
                Toast.error('Failed to load requests');
            });
    }

    // Format Date
    function formatDate(dateString) {
        if (!dateString) return 'N/A';
        try {
            const date = new Date(dateString);
            return date.toLocaleDateString('en-US', {
                year: 'numeric',
                month: 'short',
                day: 'numeric'
            });
        } catch (e) {
            return 'N/A';
        }
    }

    // Add Request Button
    document.getElementById('addRequestBtn').onclick = function() {
        document.getElementById('modalTitle').textContent = 'Add Recruitment Request';
        document.getElementById('deleteRequest').classList.add('d-none');
        document.getElementById('requestForm').reset();
        document.getElementById('requestForm').elements['status'].value = 'new';
        requestModal.show();
    };

    // Edit Request
    window.editRequest = function(index) {
        document.getElementById('modalTitle').textContent = 'Edit Recruitment Request';
        document.getElementById('deleteRequest').classList.remove('d-none');
        
        fetch(`/api/v1/company/${companyId}/recruitment-requests`)
            .then(response => response.json())
            .then(data => {
                if (!data.success || !data.requests) throw new Error('Invalid data');
                
                const request = data.requests[index];
                document.getElementById('requestForm').elements['requestId'].value = index;
                document.getElementById('requestForm').elements['position'].value = request.role;
                document.getElementById('requestForm').elements['charge'].value = request.charge;
                document.getElementById('requestForm').elements['status'].value = request.status;
                document.getElementById('requestForm').elements['notes'].value = request.notes || '';
                
                requestModal.show();
            })
            .catch(error => {
                console.error('Error:', error);
                Toast.error('Failed to load request details');
            });
    };

    // Save Request
    document.getElementById('saveRequest').onclick = function() {
        const formData = new FormData(document.getElementById('requestForm'));
        const requestData = {
            position: formData.get('position'),
            charge: parseFloat(formData.get('charge')),
            status: formData.get('status'),
            notes: formData.get('notes')
        };

        const method = document.getElementById('deleteRequest').classList.contains('d-none') ? 'POST' : 'PUT';
        const url = document.getElementById('deleteRequest').classList.contains('d-none') 
            ? `/api/v1/company/${companyId}/recruitment-request`
            : `/api/v1/company/${companyId}/recruitment-request/${formData.get('requestId')}`;

        fetch(url, {
            method: method,
            headers: {
                'Content-Type': 'application/json',
                'X-CSRF-Token': document.querySelector('meta[name="csrf-token"]').content
            },
            body: JSON.stringify(requestData)
        })
        .then(response => {
            if (!response.ok) throw new Error('Failed to save request');
            return response.json();
        })
        .then(data => {
            if (!data.success) throw new Error(data.message || 'Failed to save request');
            
            requestModal.hide();
            loadRequests();
            Toast.success(`Request ${document.getElementById('deleteRequest').classList.contains('d-none') ? 'added' : 'updated'} successfully`);
        })
        .catch(error => {
            console.error('Error:', error);
            Toast.error(error.message);
        });
    };

    // Delete Request
    document.getElementById('deleteRequest').onclick = function() {
        if (!confirm('Are you sure you want to delete this request? This action cannot be undone.')) {
            return;
        }

        const requestId = document.getElementById('requestForm').elements['requestId'].value;
        
        fetch(`/api/v1/company/${companyId}/recruitment-request/${requestId}`, {
            method: 'DELETE',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRF-Token': document.querySelector('meta[name="csrf-token"]').content
            }
        })
        .then(response => {
            if (!response.ok) throw new Error('Failed to delete request');
            return response.json();
        })
        .then(data => {
            if (!data.success) throw new Error(data.message || 'Failed to delete request');
            
            requestModal.hide();
            loadRequests();
            Toast.success('Request deleted successfully');
        })
        .catch(error => {
            console.error('Error:', error);
            Toast.error(error.message);
        });
    };

    // Update Company Status
    window.updateCompanyStatus = function(newStatus) {
        fetch(`/api/v1/company/${companyId}/status`, {
            method: 'PUT',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRF-Token': document.querySelector('meta[name="csrf-token"]').content
            },
            body: JSON.stringify({ status: newStatus })
        })
        .then(response => response.json())
        .then(data => {
            if (!data.success) {
                throw new Error(data.message || 'Failed to update status');
            }
            
            // Update the status badge
            const statusBadge = document.querySelector('.header-status-badge');
            statusBadge.className = `header-status-badge header-status-${newStatus}`;
            statusBadge.textContent = newStatus.replace('_', ' ').split(' ').map(word => 
                word.charAt(0).toUpperCase() + word.slice(1)
            ).join(' ');
            
            // Show success message, but if there's a points error, show it as a warning
            if (data.points_error) {
                Toast.warning(data.message);
            } else {
                Toast.success(data.message);
            }
            
            // Reload the page to update the timeline
            setTimeout(() => location.reload(), 1000);
        })
        .catch(error => {
            console.error('Error:', error);
            Toast.error(error.message);
        });
    };

    // Edit Company Form Submission
    document.getElementById('saveCompanyEdit').addEventListener('click', function() {
        const formData = new FormData(document.getElementById('editCompanyForm'));
        const companyData = Object.fromEntries(formData.entries());

        fetch(`/api/v1/company/${companyId}`, {
            method: 'PUT',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRF-Token': document.querySelector('meta[name="csrf-token"]').content
            },
            body: JSON.stringify(companyData)
        })
        .then(response => {
            if (!response.ok) throw new Error('Failed to update company');
            return response.json();
        })
        .then(data => {
            if (!data.success) throw new Error(data.message || 'Failed to update company');
            
            // Update the page content
            document.querySelector('h1').textContent = companyData.name;
            
            // Close the modal
            bootstrap.Modal.getInstance(document.getElementById('editCompanyModal')).hide();
            
            // Show success message
            Toast.success('Company updated successfully');
            
            // Reload the page to reflect all changes
            setTimeout(() => location.reload(), 1000);
        })
        .catch(error => {
            console.error('Error:', error);
            Toast.error(error.message);
        });
    });

    // Initial load
    loadRequests();
});
</script>
{% endblock %}

<meta name="csrf-token" content="{{ csrf_token() }}"> 