{% extends "base.html" %}

{% block head %}
<style>
    .driver-header {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        border-radius: 10px;
        padding: 2rem;
        margin-bottom: 2rem;
    }
    
    .driver-avatar-large {
        width: 80px;
        height: 80px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        font-weight: bold;
        font-size: 2rem;
        background: rgba(255, 255, 255, 0.2);
        border: 3px solid rgba(255, 255, 255, 0.3);
    }
    
    .stat-card {
        background: white;
        border-radius: 10px;
        padding: 1.5rem;
        box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        border-left: 4px solid #007bff;
        transition: transform 0.2s;
    }
    
    .stat-card:hover {
        transform: translateY(-2px);
    }
    
    .stat-number {
        font-size: 2rem;
        font-weight: bold;
        color: #007bff;
    }
    
    .alert-timeline {
        max-height: 400px;
        overflow-y: auto;
    }
    
    .alert-item {
        border-left: 3px solid #dee2e6;
        padding-left: 1rem;
        margin-bottom: 1rem;
        position: relative;
    }
    
    .alert-item::before {
        content: '';
        position: absolute;
        left: -6px;
        top: 0.5rem;
        width: 10px;
        height: 10px;
        border-radius: 50%;
        background: #007bff;
    }
    
    .alert-item.severity-critical::before { background: #dc3545; }
    .alert-item.severity-high::before { background: #fd7e14; }
    .alert-item.severity-medium::before { background: #ffc107; }
    .alert-item.severity-low::before { background: #28a745; }
    
    .info-section {
        background: #f8f9fa;
        border-radius: 8px;
        padding: 1.5rem;
        margin-bottom: 1.5rem;
    }
    
    .info-section h6 {
        color: #495057;
        font-weight: 600;
        margin-bottom: 1rem;
        padding-bottom: 0.5rem;
        border-bottom: 2px solid #007bff;
    }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid px-4">
    <!-- Back Button -->
    <div class="row mb-3">
        <div class="col-12">
            <a href="{{ url_for('drivers.index') }}" class="btn btn-outline-secondary">
                <i class="fas fa-arrow-left me-2"></i>Back to Drivers
            </a>
        </div>
    </div>

    <!-- Driver Header -->
    <div class="row">
        <div class="col-12">
            <div class="driver-header">
                <div class="row align-items-center">
                    <div class="col-auto">
                        <div class="driver-avatar-large" id="driverAvatar">
                            {{ driver.name[0].upper() if driver.name else 'D' }}
                        </div>
                    </div>
                    <div class="col">
                        <h1 class="mb-1" id="driverName">{{ driver.name or 'Unknown Driver' }}</h1>
                        <p class="mb-2 opacity-75" id="driverInfo">
                            <i class="fas fa-id-card me-2"></i>Driver ID: {{ driver.driver_id }}
                            {% if driver.username %}
                            <span class="ms-3"><i class="fas fa-user me-2"></i>{{ driver.username }}</span>
                            {% endif %}
                        </p>
                        <div class="d-flex gap-2">
                            <span class="badge bg-light text-dark" id="driverStatus">
                                <i class="fas fa-circle me-1"></i>
                                {{ 'Active' if driver.is_active else 'Inactive' }}
                            </span>
                            {% if driver.company %}
                            <span class="badge bg-light text-dark">
                                <i class="fas fa-building me-1"></i>{{ driver.company.name }}
                            </span>
                            {% endif %}
                        </div>
                    </div>
                    <div class="col-auto">
                        <button class="btn btn-light" onclick="refreshDriverData()">
                            <i class="fas fa-sync-alt me-2"></i>Refresh
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Statistics Cards -->
    <div class="row mb-4" id="statsContainer">
        <!-- Stats will be loaded here -->
    </div>

    <!-- Main Content -->
    <div class="row">
        <!-- Left Column - Driver Information -->
        <div class="col-md-8">
            <!-- Basic Information -->
            <div class="info-section">
                <h6><i class="fas fa-user me-2"></i>Basic Information</h6>
                <div class="row" id="basicInfo">
                    <!-- Basic info will be loaded here -->
                </div>
            </div>

            <!-- Contact Information -->
            <div class="info-section">
                <h6><i class="fas fa-phone me-2"></i>Contact Information</h6>
                <div class="row" id="contactInfo">
                    <!-- Contact info will be loaded here -->
                </div>
            </div>

            <!-- License Information -->
            <div class="info-section">
                <h6><i class="fas fa-id-card me-2"></i>License Information</h6>
                <div class="row" id="licenseInfo">
                    <!-- License info will be loaded here -->
                </div>
            </div>

            <!-- Samsara Data (if available) -->
            <div class="info-section" id="samsaraDataSection" style="display: none;">
                <h6><i class="fas fa-database me-2"></i>Samsara Data</h6>
                <div id="samsaraData">
                    <!-- Samsara data will be loaded here -->
                </div>
            </div>
        </div>

        <!-- Right Column - Alert History -->
        <div class="col-md-4">
            <div class="card shadow">
                <div class="card-header">
                    <h6 class="mb-0"><i class="fas fa-exclamation-triangle me-2"></i>Recent Alerts</h6>
                </div>
                <div class="card-body p-0">
                    <div class="alert-timeline p-3" id="alertTimeline">
                        <!-- Alert timeline will be loaded here -->
                    </div>
                </div>
                <div class="card-footer">
                    <a href="{{ url_for('dashboard.alerts_dashboard') }}?driver_id={{ driver.id }}" class="btn btn-sm btn-primary">
                        <i class="fas fa-external-link-alt me-1"></i>View All Alerts
                    </a>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
// Store driver ID for JavaScript functions
const DRIVER_ID = {{ driver.id }};

// Initialize page
document.addEventListener('DOMContentLoaded', function() {
    loadDriverDetails();
});

// Load driver details via API
async function loadDriverDetails() {
    try {
        const response = await fetch(`/drivers/api/drivers/${DRIVER_ID}`);
        const data = await response.json();
        
        if (data.status === 'success') {
            renderDriverDetails(data.driver);
        } else {
            showError('Failed to load driver details');
        }
    } catch (error) {
        console.error('Error loading driver details:', error);
        showError('Failed to load driver details');
    }
}

// Render driver details
function renderDriverDetails(driver) {
    // Update header info
    document.getElementById('driverName').textContent = driver.name || 'Unknown Driver';
    document.getElementById('driverAvatar').textContent = (driver.name || 'D')[0].toUpperCase();
    
    // Update status
    const statusElement = document.getElementById('driverStatus');
    statusElement.innerHTML = `<i class="fas fa-circle me-1"></i>${driver.is_active ? 'Active' : 'Inactive'}`;
    statusElement.className = `badge ${driver.is_active ? 'bg-success' : 'bg-danger'}`;
    
    // Render statistics
    renderStats(driver.alert_stats);
    
    // Render basic information
    renderBasicInfo(driver);
    
    // Render contact information
    renderContactInfo(driver);
    
    // Render license information
    renderLicenseInfo(driver);
    
    // Render alert timeline
    renderAlertTimeline(driver.recent_alerts);
    
    // Render Samsara data if available
    if (driver.samsara_data) {
        renderSamsaraData(driver.samsara_data);
    }
}

// Render statistics cards
function renderStats(stats) {
    const container = document.getElementById('statsContainer');
    container.innerHTML = `
        <div class="col-md-3">
            <div class="stat-card">
                <div class="stat-number">${stats.total}</div>
                <div class="text-muted">Total Alerts</div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="stat-card">
                <div class="stat-number text-warning">${stats.unassigned}</div>
                <div class="text-muted">Unassigned</div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="stat-card">
                <div class="stat-number text-info">${stats.in_progress}</div>
                <div class="text-muted">In Progress</div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="stat-card">
                <div class="stat-number text-success">${stats.resolved}</div>
                <div class="text-muted">Resolved</div>
            </div>
        </div>
    `;
}

// Render basic information
function renderBasicInfo(driver) {
    const container = document.getElementById('basicInfo');
    container.innerHTML = `
        <div class="col-md-6">
            <strong>Driver ID:</strong><br>
            <span class="text-muted">${driver.driver_id || 'N/A'}</span>
        </div>
        <div class="col-md-6">
            <strong>Username:</strong><br>
            <span class="text-muted">${driver.username || 'N/A'}</span>
        </div>
        <div class="col-md-6 mt-3">
            <strong>Company:</strong><br>
            <span class="text-muted">${driver.company ? driver.company.name : 'No Company'}</span>
        </div>
        <div class="col-md-6 mt-3">
            <strong>Status:</strong><br>
            <span class="badge ${driver.is_active ? 'bg-success' : 'bg-danger'}">${driver.is_active ? 'Active' : 'Inactive'}</span>
        </div>
    `;
}

// Render contact information
function renderContactInfo(driver) {
    const container = document.getElementById('contactInfo');
    container.innerHTML = `
        <div class="col-md-6">
            <strong>Phone:</strong><br>
            <span class="text-muted">${driver.phone || 'N/A'}</span>
        </div>
        <div class="col-md-6">
            <strong>Email:</strong><br>
            <span class="text-muted">${driver.email || 'N/A'}</span>
        </div>
    `;
}

// Render license information
function renderLicenseInfo(driver) {
    const container = document.getElementById('licenseInfo');
    container.innerHTML = `
        <div class="col-md-4">
            <strong>License Number:</strong><br>
            <span class="text-muted">${driver.license_number || 'N/A'}</span>
        </div>
        <div class="col-md-4">
            <strong>License State:</strong><br>
            <span class="text-muted">${driver.license_state || 'N/A'}</span>
        </div>
        <div class="col-md-4">
            <strong>License Class:</strong><br>
            <span class="text-muted">${driver.license_class || 'N/A'}</span>
        </div>
    `;
}

// Render alert timeline
function renderAlertTimeline(alerts) {
    const container = document.getElementById('alertTimeline');
    
    if (!alerts || alerts.length === 0) {
        container.innerHTML = `
            <div class="text-center text-muted py-4">
                <i class="fas fa-info-circle fa-2x mb-2"></i>
                <div>No recent alerts</div>
            </div>
        `;
        return;
    }
    
    container.innerHTML = alerts.map(alert => `
        <div class="alert-item severity-${alert.severity}">
            <div class="d-flex justify-content-between align-items-start">
                <div>
                    <strong>${alert.alert_type}</strong>
                    <div class="text-muted small">${alert.vehicle_name}</div>
                </div>
                <span class="badge bg-${getSeverityColor(alert.severity)}">${alert.severity}</span>
            </div>
            <div class="text-muted small mt-1">
                ${formatDateTime(alert.timestamp)}
            </div>
        </div>
    `).join('');
}

// Render Samsara data
function renderSamsaraData(data) {
    const section = document.getElementById('samsaraDataSection');
    const container = document.getElementById('samsaraData');
    
    if (data && Object.keys(data).length > 0) {
        section.style.display = 'block';
        container.innerHTML = `<pre class="bg-light p-3 rounded">${JSON.stringify(data, null, 2)}</pre>`;
    }
}

// Utility functions
function getSeverityColor(severity) {
    const colors = {
        'critical': 'danger',
        'high': 'warning',
        'medium': 'info',
        'low': 'success'
    };
    return colors[severity] || 'secondary';
}

function formatDateTime(dateString) {
    if (!dateString) return 'N/A';
    return new Date(dateString).toLocaleString();
}

function refreshDriverData() {
    loadDriverDetails();
}

function showError(message) {
    // You can implement a toast notification here
    alert('Error: ' + message);
}
</script>
{% endblock %} 