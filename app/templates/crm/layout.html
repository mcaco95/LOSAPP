{% extends "base.html" %}

{% block head %}
{{ super() }}
<!-- THIS IS CRM LAYOUT HEAD BLOCK --> {# Add verification comment #}
{# Basic CSS for the floating button - consider moving to a CSS file #}
<style>
  .crm-fab {
    position: fixed;
    bottom: 25px;
    right: 25px;
    z-index: 1050; /* Ensure it's above most other elements */
  }
  
  .popup-alert {
    position: fixed;
    bottom: 100px;
    right: 25px;
    z-index: 1049;
    max-width: 300px;
    display: none;
  }
</style>
{% endblock %}

{% block content %}
<!-- THIS IS CRM LAYOUT CONTENT BLOCK --> {# Add verification comment #}
<main class="content">
    {# Topbar is included by base.html #}
    {# Main page content for CRM pages #}
    <div class="py-4">
        {# Optional: Add breadcrumbs or specific headers here if needed #}
        <div class="d-flex justify-content-between w-100 flex-wrap">
            <div class="mb-3 mb-lg-0">
                <h1 class="h4">{% block page_title %}{% endblock %}</h1>
                <p class="mb-0">{% block page_description %}{% endblock %}</p>
            </div>
            {# Optional: Add buttons or actions for the page header #}
        </div>
    </div>

    {# Flash messages are handled by base.html or included partials usually #}
    {% with messages = get_flashed_messages(with_categories=true) %}
      {% if messages %}
        {% for category, message in messages %}
          <div class="alert alert-{{ category }} alert-dismissible fade show" role="alert">
            {{ message }}
            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
          </div>
        {% endfor %}
      {% endif %}
    {% endwith %}

    {# Specific page content block #}
    {% block page_content %}
    {% endblock %}

    {# Footer is included by base.html #}
</main>

{# {% if current_user.is_authenticated and current_user.sales_profile %} #}
<!-- Floating Phone Widget Button for CRM -->
<div id="crm-phone-widget" class="position-fixed bottom-0 end-0 mb-4 me-4" style="z-index: 1040;">
    <button id="open-crm-phone-btn" class="btn btn-success rounded-circle" style="width: 60px; height: 60px; box-shadow: 0 4px 6px rgba(0,0,0,0.1);" title="Open CRM Phone">
        <i class="fas fa-headset" style="font-size: 24px;"></i>
    </button>
</div>

<!-- Pop-up Blocker Alert -->
<div id="popup-alert" class="alert alert-warning alert-dismissible fade popup-alert">
    <strong>Pop-up Blocked!</strong> Please allow pop-ups for the phone system to work.
    <hr>
    <p class="mb-0">Look for the pop-up blocker icon in your browser's address bar and click "Allow" to enable the phone system.</p>
    <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
</div>
{# {% endif %} #}
{% endblock %}

{% block extra_js %}
{{ super() }} {# Include scripts from base.html #}

{# {% if current_user.is_authenticated and current_user.sales_profile %} #} {# Temporarily commented out #}
<script>
    // JavaScript for the CRM Phone FAB
    console.log('[CRM Phone Widget] Script block started.');

    function showPopupAlert() {
        console.log('[CRM Phone Widget] showPopupAlert called.');
        const alert = document.getElementById('popup-alert');
        if (alert) {
            alert.classList.add('show');
            alert.style.display = 'block';
            setTimeout(() => {
                alert.classList.remove('show');
                setTimeout(() => {
                    alert.style.display = 'none';
                }, 150);
            }, 10000);
        } else {
            console.error('[CRM Phone Widget] popup-alert element not found.');
        }
    }
    
    function openCrmPhoneWindow() {
        console.log('[CRM Phone Widget] openCrmPhoneWindow function called.');
        const windowFeatures = 'width=320,height=650,resizable=yes,top=100,left=150,menubar=no,toolbar=no,location=no,status=no,titlebar=yes';
        const windowUrl = "{{ url_for('crm_phone.phone_interface') }}";
        const windowName = "LOS_CRM_Phone_Window";
        console.log('[CRM Phone Widget] Attempting to open window. URL:', windowUrl, 'Name:', windowName, 'Features:', windowFeatures);
        
        try {
            const phoneWindow = window.open(windowUrl, windowName, windowFeatures);
            if (phoneWindow) {
                console.log('[CRM Phone Widget] window.open call succeeded. Focusing window.');
                phoneWindow.focus();
            } else {
                console.error('[CRM Phone Widget] window.open call returned null or undefined. Pop-up blocker likely active or other restriction.');
                showPopupAlert();
            }
        } catch (e) {
            console.error('[CRM Phone Widget] Error during window.open call:', e);
            showPopupAlert(); // Show alert on error too
        }
    }
    
    document.addEventListener('DOMContentLoaded', function() {
        console.log('[CRM Phone Widget] DOMContentLoaded event fired.');
        const crmPhoneBtn = document.getElementById('open-crm-phone-btn');
        if (crmPhoneBtn) {
             console.log('[CRM Phone Widget] Found button #open-crm-phone-btn. Attaching click listener.');
             crmPhoneBtn.addEventListener('click', function(event) {
                console.log('[CRM Phone Widget] #open-crm-phone-btn clicked. Event:', event);
                openCrmPhoneWindow();
             });
             console.log('[CRM Phone Widget] Click listener attached to #open-crm-phone-btn.');
        } else {
             console.error('[CRM Phone Widget] Button #open-crm-phone-btn NOT found.');
        }
        console.log('[CRM Phone Widget] DOMContentLoaded handler finished.');
    });
    console.log('[CRM Phone Widget] Script block finished parsing.');
</script>
{# {% endif %} #} {# Temporarily commented out #}
{% endblock %} 