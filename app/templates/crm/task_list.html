{% extends "crm/layout.html" %}
{% from "_formhelpers.html" import render_field, render_submit_field, render_query_select_field, render_textarea_field, render_date_field %}
{% from "partials/_pagination.html" import render_pagination %}

{% block title %}{{ title }}{% endblock %}

{% block page_title %}{{ title }}{% endblock %}

{% block page_description %}
Create and manage your CRM tasks here.
{% endblock %}

{% block content %}
{{ super() }}
<div class="py-4">
    <nav aria-label="breadcrumb" class="d-none d-md-inline-block">
        <ol class="breadcrumb breadcrumb-dark breadcrumb-transparent">
            <li class="breadcrumb-item">
                <a href="{{ url_for('main.dashboard') }}">
                    <svg class="icon icon-xxs" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 12l2-2m0 0l7-7 7 7M5 10v10a1 1 0 001 1h3m10-11l2 2m-2-2v10a1 1 0 01-1 1h-3m-6 0a1 1 0 001-1v-4a1 1 0 011-1h2a1 1 0 011 1v4a1 1 0 001 1m-6 0h6"></path></svg>
                </a>
            </li>
            <li class="breadcrumb-item"><a href="{{ url_for('crm.dashboard') }}">CRM</a></li>
            <li class="breadcrumb-item active" aria-current="page">Tasks</li>
        </ol>
    </nav>
    <div class="d-flex justify-content-between w-100 flex-wrap">
        <div class="mb-3 mb-lg-0">
            <h1 class="h4">{{ title }}</h1>
            <p class="mb-0">Create and manage CRM tasks.</p>
        </div>
    </div>
</div>

{# Task Creation Form - Consider moving to its own card/modal later #}
<div class="card border-0 shadow mb-4">
    <div class="card-header">
        <h2 class="h5 mb-0">Create New Task</h2>
    </div>
    <div class="card-body">
        <form method="POST" action="{{ url_for('crm.manage_tasks') }}">
            {{ form.hidden_tag() }}
            <div class="row">
                <div class="col-md-6 mb-3">
                    {{ render_field(form.title, class='form-control') }}
                </div>
                <div class="col-md-3 mb-3">
                     {{ render_field(form.status, class='form-select') }}
                </div>
                 <div class="col-md-3 mb-3">
                    {{ render_field(form.priority, class='form-select') }}
                </div>
            </div>
            <div class="mb-3">
                 {{ render_textarea_field(form.description, class='form-control', rows=3) }}
            </div>
            <div class="row">
                <div class="col-md-4 mb-3">
                    {{ render_date_field(form.due_date, class='form-control') }}
                </div>
                 <div class="col-md-4 mb-3">
                    {{ render_query_select_field(form.contact_id, class='form-select') }}
                </div>
                 <div class="col-md-4 mb-3">
                    {{ render_query_select_field(form.crm_account_id, class='form-select') }}
                </div>
                 <div class="col-md-4 mb-3">
                    {{ render_query_select_field(form.deal_id, class='form-select') }}
                </div>
            </div>
            {{ render_submit_field(form.submit, class='btn btn-primary') }}
        </form>
    </div>
</div>

{# Task List #}
<div class="card border-0 shadow mb-4">
    <div class="card-header">
        <h2 class="h5 mb-0">Existing Tasks</h2>
    </div>
    <div class="card-body">
        <div class="table-responsive">
            <table class="table table-centered table-nowrap mb-0 rounded">
                <thead class="thead-light">
                    <tr>
                        <th class="border-0 rounded-start">Title</th>
                        <th class="border-0">Due Date</th>
                        <th class="border-0">Status</th>
                        <th class="border-0">Priority</th>
                        <th class="border-0">Related To</th>
                        <th class="border-0">Assigned To</th>
                        <th class="border-0 rounded-end">Actions</th>
                    </tr>
                </thead>
                <tbody class="list" id="task-table-body">
                    {% if tasks %}
                        {% for task in tasks %}
                        {# Determine row class based on status and due date #}
                        {% set row_class = '' %}
                        {% if task.status == 'Completed' %}
                            {% set row_class = 'text-muted' %}
                        {% elif task.due_date and task.due_date.date() < today %}
                            {% set row_class = 'table-danger' %}
                        {% endif %}
                        <tr class="{{ row_class }}">
                            <td class="fw-bolder">
                                {{ task.title }}
                            </td>
                            <td class="text-center">
                                <span class="badge {% if task.status == 'Completed' %}bg-success{% elif task.status == 'In Progress' %}bg-info{% elif task.status == 'Pending' %}bg-warning{% else %}bg-secondary{% endif %}">
                                    {{ task.status }}
                                </span>
                                {% if task.due_date and task.due_date.date() < today and task.status != 'Completed' %}
                                <span class="badge bg-danger ms-1">Overdue</span>
                                {% endif %}
                            </td>
                            <td class="text-center">
                                <small class="d-block text-muted">
                                    {% if task.due_date %}
                                        {% if task.due_date.date() < today and task.status != 'Completed' %}
                                            Due {{ (today - task.due_date.date()).days }} days ago
                                        {% elif task.due_date.date() == today and task.status != 'Completed' %}
                                            Due Today
                                        {% elif task.due_date.date() > today and task.status != 'Completed' %}
                                            Due in {{ (task.due_date.date() - today).days }} days
                                        {% else %}
                                            Due: {{ task.due_date.strftime('%b %d, %Y') }}
                                        {% endif %}
                                    {% else %}
                                        No due date
                                    {% endif %}
                                </small>
                            </td>
                            <td>
                                {# Could use different colors based on priority #}
                                {% set priority_class = 'secondary' %}
                                {% if task.priority == 'High' %} {% set priority_class = 'danger' %} {% endif %}
                                {% if task.priority == 'Medium' %} {% set priority_class = 'warning' %} {% endif %}
                                <span class="badge bg-{{ priority_class }}">{{ task.priority }}</span>
                            </td>
                            <td>
                                {% if task.deal %}
                                    <a href="{{ url_for('crm.view_deal', deal_id=task.deal.id) }}">Deal: {{ task.deal.name }}</a>
                                {% elif task.contact %}
                                    <a href="{{ url_for('crm.view_contact', contact_id=task.contact.id) }}">Contact: {{ task.contact.full_name }}</a>
                                {% elif task.crm_account %}
                                    <a href="{{ url_for('crm.view_account', account_id=task.crm_account.id) }}">Account: {{ task.crm_account.name }}</a>
                                {% else %}
                                    -
                                {% endif %}
                            </td>
                            <td>{{ task.sales_rep.user.name if task.sales_rep else 'Unknown' }}</td>
                            <td>
                                <a href="{{ url_for('crm.edit_task', task_id=task.id) }}" class="btn btn-sm btn-outline-info" title="Edit">
                                    <i class="fas fa-edit"></i>
                                </a>
                                <form action="{{ url_for('crm.delete_task', task_id=task.id) }}" method="POST" style="display: inline-block;" onsubmit="return confirm('Are you sure you want to delete this task?');">
                                    <input type="hidden" name="csrf_token" value="{{ csrf_token }}">
                                    <button type="submit" class="btn btn-sm btn-outline-danger" title="Delete">
                                        <i class="fas fa-trash-alt"></i>
                                    </button>
                                </form>
                            </td>
                        </tr>
                        {% endfor %}
                    {% else %}
                        <tr>
                            <td colspan="7" class="text-center">No tasks found.</td>
                        </tr>
                    {% endif %}
                </tbody>
            </table>
        </div>
        {# Render pagination controls #}
        {% if pagination %}
            {{ render_pagination(pagination, 'crm.manage_tasks') }}
        {% endif %}
    </div>
</div>

{% endblock %}

{% block extra_js %}
{{ super() }}
{# Add any task-list-specific JS here if needed in the future #}
{% endblock %} 