{% extends "base.html" %}
{% from "_formhelpers.html" import render_field %}

{% block content %}
<h1>DEBUG: TOP OF APP_CONTENT BLOCK</h1>

<div class="container mt-4">
    <h2>Confirm CSV Import Mapping for '{{ original_filename }}'</h2>
    <p>You are importing: <strong>{{ 'Contacts' if import_type == 'contacts' else 'Accounts' }}</strong></p>
    <hr>

    <form method="POST" action="{{ url_for('crm.process_mapped_import') }}">
        {{ form.csrf_token }} {# Use the csrf_token from the passed form object #}

        <p>For each column header from your CSV file listed below, select the CRM field it corresponds to, or choose 'Ignore this column' if you don't want to import it.</p>

        <table class="table table-striped table-bordered">
            <thead class="thead-light">
                <tr>
                    <th>CSV Header</th>
                    <th>Map to CRM Field</th>
                </tr>
            </thead>
            <tbody>
                {% for header in headers %}
                <tr>
                    <td>{{ header }}</td>
                    <td>
                        <select name="map_{{ loop.index0 }}" class="form-select form-select-sm">
                            <option value="_ignore_">-- Ignore this column --</option>
                            {% for field_key, field_label in target_fields.items() %}
                                {# Attempt to pre-select if header matches (case-insensitive, space-insensitive) #}
                                {% set simple_header = header.lower().replace(' ', '').replace('_', '') %}
                                {% set simple_field_key = field_key.lower().replace(' ', '').replace('_', '') %}
                                {% set simple_field_label = field_label.lower().replace(' ', '').replace('_', '') %}
                                
                                <option value="{{ field_key }}" 
                                        {% if simple_header == simple_field_key or simple_header == simple_field_label %}
                                            selected
                                        {% endif %}>
                                    {{ field_label }}
                                </option>
                            {% endfor %}
                        </select>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>

        <div class="mt-3 mb-3">
            <p class="text-muted small">
                <strong>Important Notes:</strong>
                <ul>
                    {% if import_type == 'contacts' %}
                        <li>For <strong>Contacts</strong>, 'Last Name' or 'Email' is recommended for each contact.</li>
                        <li>If mapping to 'Account Name (for linking)', the system will try to link to an existing Account with that exact name (case-sensitive) belonging to you. If not found, the contact will be created without an account link.</li>
                        <li>Existing contacts (matched by email, if provided) will be skipped to avoid duplicates.</li>
                    {% elif import_type == 'accounts' %}
                        <li>For <strong>Accounts</strong>, 'Account Name' is required for each account.</li>
                        <li>Existing accounts (matched by name) will be skipped to avoid duplicates.</li>
                    {% endif %}
                     <li>Ensure your CSV file is encoded in UTF-8 (UTF-8 with BOM is also supported).</li>
                     <li>For fields like 'Custom Data', if you provide valid JSON text (e.g., `{"key": "value"}`), it will be stored as a JSON object. Otherwise, it will be stored as plain text. If multiple columns from your CSV are mapped to 'Custom Data', they will be grouped into a JSON object using their original CSV header names as keys.</li>
                </ul>
            </p>
        </div>

        <button type="submit" class="btn btn-primary me-2">
            <i class="bi bi-check-circle-fill"></i> Process Mapped Import
        </button>
        <a href="{{ url_for('crm.import_csv') }}" class="btn btn-secondary">
            <i class="bi bi-x-circle"></i> Cancel and Upload New File
        </a>
    </form>
</div>

<p>DEBUG: BOTTOM OF APP_CONTENT BLOCK</p>
{% endblock content %} 