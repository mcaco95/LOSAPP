{% extends "crm/layout.html" %}
{% from "_formhelpers.html" import render_submit_field %}

{% block page_title %}{{ deal.name }} - Deal Details{% endblock %}

{% block page_content %}
<div class="py-4">
    <nav aria-label="breadcrumb" class="d-none d-md-inline-block">
        <ol class="breadcrumb breadcrumb-dark breadcrumb-transparent">
            <li class="breadcrumb-item">
                <a href="{{ url_for('crm.dashboard') }}">
                    <svg class="icon icon-xxs" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 12l2-2m0 0l7-7 7 7M5 10v10a1 1 0 001 1h3m10-11l2 2m-2-2v10a1 1 0 01-1 1h-3m-6 0a1 1 0 001-1v-4a1 1 0 011-1h2a1 1 0 011 1v4a1 1 0 001 1m-6 0h6"></path></svg>
                </a>
            </li>
            <li class="breadcrumb-item"><a href="{{ url_for('crm.list_deals') }}">Deals</a></li>
            <li class="breadcrumb-item active" aria-current="page">{{ deal.name }}</li>
        </ol>
    </nav>
    <div class="d-flex justify-content-between w-100 flex-wrap">
        <div class="mb-3 mb-lg-0">
            <h1 class="h4">{{ deal.name }}</h1>
            <p class="mb-0">Stage: <span class="badge bg-info">{{ deal.stage }}</span></p>
        </div>
        <div>
            <a href="{{ url_for('crm.edit_deal', deal_id=deal.id) }}" class="btn btn-primary me-2">
                <i class="bi bi-pencil-fill me-1"></i> Edit Deal
            </a>
            <a href="{{ url_for('crm.manage_tasks', deal_id=deal.id) }}" class="btn btn-info me-2">
                <i class="bi bi-plus-circle-fill me-1"></i> New Task for this Deal
            </a>
            <a href="{{ url_for('crm.list_deals') }}" class="btn btn-outline-gray-600 d-inline-flex align-items-center">
                <i class="bi bi-arrow-left me-2"></i> Back to Deals
            </a>
        </div>
    </div>
</div>

{% include 'partials/_flash_messages.html' %}

<div class="row">
    <div class="col-12 col-xl-8">
        <div class="card card-body border-0 shadow mb-4">
            <h2 class="h5 mb-4">Deal Information</h2>
            <ul class="list-group list-group-flush">
                <li class="list-group-item d-flex align-items-center justify-content-between px-0 border-bottom">
                    <div>
                        <h3 class="h6 mb-1">Amount</h3>
                        <p class="small pe-4 mb-0">${{ "%.2f"|format(deal.amount) if deal.amount is not none else "0.00" }}</p>
                    </div>
                </li>
                <li class="list-group-item d-flex align-items-center justify-content-between px-0 border-bottom">
                    <div>
                        <h3 class="h6 mb-1">Stage</h3>
                        <p class="small pe-4 mb-0">{{ deal.stage }}</p>
                    </div>
                </li>
                <li class="list-group-item d-flex align-items-center justify-content-between px-0 border-bottom">
                    <div>
                        <h3 class="h6 mb-1">Expected Close Date</h3>
                        <p class="small pe-4 mb-0">{{ deal.expected_close_date.strftime('%Y-%m-%d') if deal.expected_close_date else 'Not set' }}</p>
                    </div>
                </li>
                <li class="list-group-item d-flex align-items-center justify-content-between px-0 border-bottom">
                    <div>
                        <h3 class="h6 mb-1">Probability</h3>
                        <p class="small pe-4 mb-0">{{ deal.probability ~ '%' if deal.probability is not none else 'Not set' }}</p>
                    </div>
                </li>
                <li class="list-group-item d-flex align-items-center justify-content-between px-0 border-bottom">
                    <div>
                        <h3 class="h6 mb-1">Associated Account</h3>
                        {% if deal.crm_account %}
                            <a href="{{ url_for('crm.view_account', account_id=deal.crm_account.id) }}">{{ deal.crm_account.name }}</a>
                        {% else %}
                            <p class="small pe-4 mb-0">None</p>
                        {% endif %}
                    </div>
                </li>
                <li class="list-group-item d-flex align-items-center justify-content-between px-0 border-bottom">
                    <div>
                        <h3 class="h6 mb-1">Primary Contact</h3>
                        {% if deal.contact %}
                            <a href="{{ url_for('crm.view_contact', contact_id=deal.contact.id) }}">{{ deal.contact.full_name }}</a>
                        {% else %}
                            <p class="small pe-4 mb-0">None</p>
                        {% endif %}
                    </div>
                </li>
                <li class="list-group-item d-flex align-items-center justify-content-between px-0">
                    <div>
                        <h3 class="h6 mb-1">Description</h3>
                        <p class="text-wrap mb-0">{{ deal.description if deal.description else 'No description provided.' }}</p>
                    </div>
                </li>
            </ul>
        </div>

        {# Related Tasks Section #}
        <div class="card card-body border-0 shadow mb-4">
            <h2 class="h5 mb-4">Related Tasks ({{ related_tasks|length }})</h2>
            {% if related_tasks %}
                <ul class="list-group list-group-flush">
                    {% for task in related_tasks %}
                        <li class="list-group-item d-flex justify-content-between align-items-center px-0">
                            <div>
                                <a href="{{ url_for('crm.edit_task', task_id=task.id) }}">{{ task.title }}</a>
                                <small class="d-block text-muted">
                                    Status: {{ task.status }} | 
                                    Priority: {{ task.priority }} | 
                                    Due: {{ task.due_date.strftime('%Y-%m-%d') if task.due_date else 'N/A' }}
                                </small>
                                {% if task.description %}
                                    <small class="d-block text-muted fst-italic">{{ task.description|truncate(100) }}</small>
                                {% endif %}
                            </div>
                            <div>
                                <a href="{{ url_for('crm.edit_task', task_id=task.id) }}" class="btn btn-sm btn-outline-primary">
                                    <i class="bi bi-pencil"></i>
                                </a>
                                {# Add delete task form here if needed, ensuring CSRF protection #}
                            </div>
                        </li>
                    {% endfor %}
                </ul>
            {% else %}
                <p class="text-muted">No tasks are currently associated with this deal. 
                    <a href="{{ url_for('crm.manage_tasks', deal_id=deal.id) }}">Add a new task</a>.
                </p>
            {% endif %}
        </div>
        {# End Related Tasks Section #}

        {# Recent Notes from Primary Contact Section #}
        {% if deal.contact and recent_notes %}
        <div class="card card-body border-0 shadow mb-4">
            <h2 class="h5 mb-3">Recent Notes from {{ deal.contact.full_name }} ({{ recent_notes|length }})</h2>
            <ul class="list-group list-group-flush">
                {% for note in recent_notes %}
                    <li class="list-group-item px-0">
                        <p class="mb-1">{{ note.text }}</p>
                        <small class="text-muted">
                            {{ note.timestamp.strftime('%Y-%m-%d %H:%M') if note.timestamp else 'No timestamp' }}
                            {% if note.sales_rep and note.sales_rep.user %}
                                - By: {{ note.sales_rep.user.first_name }} {{ note.sales_rep.user.last_name }}
                            {% elif note.sales_rep %}
                                - By: Sales Rep ID {{ note.sales_rep.id }} {# Fallback if user details aren't loaded #}
                            {% endif %}
                        </small>
                    </li>
                {% endfor %}
            </ul>
        </div>
        {% elif deal.contact %}
        <div class="card card-body border-0 shadow mb-4">
            <h2 class="h5 mb-3">Recent Notes from {{ deal.contact.full_name }}</h2>
            <p class="text-muted">No recent notes found for this contact.</p>
        </div>
        {% endif %}
        {# End Recent Notes Section #}
    </div>

    <div class="col-12 col-xl-4">
        <div class="card card-body border-0 shadow mb-4">
            <h2 class="h5 mb-4">Details</h2>
            <ul class="list-group list-group-flush">
                 <li class="list-group-item d-flex align-items-center justify-content-between px-0 border-bottom">
                    <div>
                        <h3 class="h6 mb-1">Owner</h3>
                        <p class="small pe-4 mb-0">{{ deal.sales_rep.user.name if deal.sales_rep and deal.sales_rep.user else 'N/A' }}</p>
                    </div>
                </li>
                <li class="list-group-item d-flex align-items-center justify-content-between px-0 border-bottom">
                    <div>
                        <h3 class="h6 mb-1">Created On</h3>
                        <p class="small pe-4 mb-0">{{ deal.created_at.strftime('%Y-%m-%d %H:%M') }}</p>
                    </div>
                </li>
                <li class="list-group-item d-flex align-items-center justify-content-between px-0">
                    <div>
                        <h3 class="h6 mb-1">Last Updated</h3>
                        <p class="small pe-4 mb-0">{{ deal.updated_at.strftime('%Y-%m-%d %H:%M') }}</p>
                    </div>
                </li>
            </ul>
        </div>
        {# Potential Delete Button/Form #}
         <form method="POST" action="{{ url_for('crm.delete_deal', deal_id=deal.id) }}" style="display: inline-block; width:100%;" onsubmit="return confirm('Are you sure you want to delete this deal? Associated tasks will be unlinked but not deleted.');">
            <input type="hidden" name="csrf_token" value="{{ csrf_token }}">
            <button type="submit" class="btn btn-danger w-100">
                <i class="bi bi-trash-fill me-1"></i> Delete Deal
            </button>
        </form>
    </div>
</div>

{% endblock %} 