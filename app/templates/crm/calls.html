{% extends "crm/layout.html" %}

{% block page_title %}Call Logs{% endblock %}

{% block page_description %}View your call history.{% endblock %}

{% block page_content %}
<div class="row">
    <div class="col-12">
        <div class="card border-0 shadow">
            <div class="card-body">
                 <h5 class="card-title">Your Call History</h5>
                 <p class="card-text">A list of your call logs will appear here.</p>
                 {# Placeholder for call log table - We will add JS to populate this #}
                 <div id="call-log-table-container">
                     <table class="table table-hover">
                         <thead>
                             <tr>
                                 <th>Time</th>
                                 <th>Direction</th>
                                 <th>Number</th>
                                 <th>Status</th>
                                 <th>Duration</th>
                                 <th>Recording</th>
                             </tr>
                         </thead>
                         <tbody id="call-log-tbody">
                             <tr><td colspan="6">Loading...</td></tr>
                         </tbody>
                     </table>
                 </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block page_scripts %}
{# Add page-specific scripts here, separate from layout scripts in extra_js #}
<script>
document.addEventListener('DOMContentLoaded', function() {
    async function fetchCallLogs() {
        const tbody = document.getElementById('call-log-tbody');
        if (!tbody) return;

        try {
            const response = await fetch("{{ url_for('crm.get_call_logs') }}"); // Use the CRM endpoint
            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }
            const data = await response.json();

            if (data.success && data.call_logs) {
                tbody.innerHTML = ''; // Clear loading message
                if (data.call_logs.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="6" class="text-center">No call logs found.</td></tr>';
                }
                data.call_logs.forEach(log => {
                    const row = tbody.insertRow();
                    const duration = log.duration ? `${log.duration}s` : '-';
                    const recordingLink = log.recording_url ? `<a href="${log.recording_url}" target="_blank">Listen</a>` : 'N/A';
                    const timestamp = log.created_at ? new Date(log.created_at).toLocaleString() : 'N/A';
                    
                    row.innerHTML = `
                        <td>${timestamp}</td>
                        <td>${log.direction || 'N/A'}</td>
                        <td>${log.to_number || 'N/A'}</td> {# Display to_number for outbound #}
                        <td><span class="badge bg-info">${log.status || 'N/A'}</span></td>
                        <td>${duration}</td>
                        <td>${recordingLink}</td>
                    `;
                });
            } else {
                 tbody.innerHTML = `<tr><td colspan="6" class="text-center">Error: ${data.message || 'Could not load logs.'}</td></tr>`;
            }
        } catch (error) {
            console.error('Error fetching call logs:', error);
            tbody.innerHTML = '<tr><td colspan="6" class="text-center">Error loading call logs.</td></tr>';
        }
    }

    fetchCallLogs(); // Load logs when page loads
});
</script>
{% endblock %} 