{% extends "crm/layout.html" %}

{% block page_title %}{{ account.name }} - Account Details{% endblock %}

{% block page_description %}Details for company {{ account.name }}.{% endblock %}

{% block page_content %}
<div class="row mb-3">
    <div class="col">
        <h1 class="h3">{{ account.name }}</h1>
    </div>
    <div class="col text-end">
        <a href="{{ url_for('crm.edit_account', account_id=account.id) }}" class="btn btn-primary me-2">
            <i class="bi bi-pencil-fill me-1"></i> Edit Account
        </a>
        <a href="{{ url_for('crm.create_deal', account_id=account.id) }}" class="btn btn-success me-2">
            <i class="bi bi-plus-circle-fill me-1"></i> New Deal
        </a>
        <a href="{{ url_for('crm.manage_tasks', account_id=account.id) }}" class="btn btn-info me-2">
            <i class="bi bi-check2-square me-1"></i> New Task
        </a>
        <form method="POST" action="{{ url_for('crm.delete_account', account_id=account.id) }}" style="display: inline-block;" onsubmit="return confirm('Are you sure you want to delete this account? Associated contacts will be unlinked.');">
            <input type="hidden" name="csrf_token" value="{{ generated_csrf_token }}">
            <button type="submit" class="btn btn-danger me-2">
                <svg class="icon icon-xs me-1" fill="currentColor" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg"><path fill-rule="evenodd" d="M9 2a1 1 0 00-.894.553L7.382 4H4a1 1 0 000 2v10a2 2 0 002 2h8a2 2 0 002-2V6a1 1 0 100-2h-3.382l-.724-1.447A1 1 0 0011 2H9zM7 8a1 1 0 012 0v6a1 1 0 11-2 0V8zm5-1a1 1 0 00-1 1v6a1 1 0 102 0V8a1 1 0 00-1-1z" clip-rule="evenodd"></path></svg>
                Delete
            </button>
        </form>
        <a href="{{ url_for('crm.accounts') }}" class="btn btn-link text-gray ms-auto">Back to List</a>
    </div>
</div>

<div class="row">
    {# Account Details Card #}
    <div class="col-md-7 mb-4"> {# Adjusted column size #}
        <div class="card border-0 shadow">
            <div class="card-header">
                <h2 class="h5 mb-0">Account Info</h2>
            </div>
            <div class="card-body">
                <ul class="list-group list-group-flush">
                    <li class="list-group-item d-flex justify-content-between align-items-center">
                        <span>Company Name</span>
                        <strong>{{ account.name }}</strong>
                    </li>
                    <li class="list-group-item d-flex justify-content-between align-items-center">
                        <span>Website</span>
                        <strong>
                            {% if account.website %}
                                <a href="{{ account.website if account.website.startswith('http') else 'http://' + account.website }}" target="_blank" rel="noopener noreferrer">
                                    {{ account.website }}
                                </a>
                            {% else %}
                                -
                            {% endif %}
                        </strong>
                    </li>
                    <li class="list-group-item d-flex justify-content-between align-items-center">
                        <span>Phone</span>
                        <strong>{{ account.phone_number or '-' }}</strong>
                    </li>
                    <li class="list-group-item d-flex justify-content-between align-items-center">
                        <span>Industry</span>
                        <strong>{{ account.industry or '-' }}</strong>
                    </li>
                    <li class="list-group-item d-flex justify-content-between align-items-start"> {# Changed to align-items-start for potentially long address #}
                        <span>Address</span>
                        <strong class="text-end">{{ account.address or '-' }}</strong> {# Added text-end for better alignment #}
                    </li>
                    <li class="list-group-item d-flex justify-content-between align-items-center">
                        <span>Status</span>
                        <span class="badge bg-info">{{ account.status or '-' }}</span> {# Placeholder badge color #}
                    </li>
                     <li class="list-group-item d-flex justify-content-between align-items-center">
                        <span>Added On</span>
                        <strong>{{ account.created_at.strftime('%Y-%m-%d') if account.created_at else '-' }}</strong>
                    </li>
                     <li class="list-group-item d-flex justify-content-between align-items-center">
                        <span>Last Updated</span>
                        <strong>{{ account.updated_at.strftime('%Y-%m-%d %H:%M') if account.updated_at else '-' }}</strong>
                    </li>
                </ul>
            </div>
        </div>
        
        {# Custom Data Card (Optional) #}
        {% if account.custom_data %}
        <div class="card border-0 shadow mt-4">
            <div class="card-header">
                <h2 class="h5 mb-0">Additional Information</h2>
            </div>
            <div class="card-body">
                {% if account.custom_data is mapping %} {# Check if it's a dictionary #}
                    <dl class="row">
                    {% for key, value in account.custom_data.items() %}
                        <dt class="col-sm-4">{{ key }}</dt>
                        <dd class="col-sm-8">{{ value }}</dd>
                    {% endfor %}
                    </dl>
                {% elif account.custom_data is iterable and account.custom_data is not string %} {# Check if it's a list #}
                    <ul class="list-unstyled">
                    {% for item in account.custom_data %}
                        <li>{{ item }}</li>
                    {% endfor %}
                    </ul>
                {% else %} {# Assume it's a string #}
                    <p>{{ account.custom_data }}</p>
                {% endif %}
            </div>
        </div>
        {% endif %}
    </div>

    {# Related Information Column (e.g., Contacts, Later: Notes, Calls linked to Account) #}
    <div class="col-md-5 mb-4"> {# Adjusted column size #}
        <div class="card border-0 shadow">
            <div class="card-header">
                <h2 class="h5 mb-0">Related Contacts</h2>
            </div>
            <div class="card-body">
                {% set related_contacts = account.contacts.all() %}
                {% if related_contacts %}
                    <ul class="list-group list-group-flush">
                    {% for contact in related_contacts %}
                        <li class="list-group-item">
                            <a href="{{ url_for('crm.view_contact', contact_id=contact.id) }}">{{ contact.full_name }}</a>
                            <small class="d-block text-muted">{{ contact.job_title or '' }}</small>
                        </li>
                    {% endfor %}
                    </ul>
                {% else %}
                    <p class="text-center text-muted">No contacts linked to this account yet.</p>
                {% endif %}
                 <div class="mt-3 text-center">
                     <a href="{{ url_for('crm.create_contact', account_id=account.id) }}" class="btn btn-sm btn-outline-primary me-2">
                         Add New Contact to this Account
                     </a>
                     <a href="{{ url_for('crm.select_contact_to_link_to_account', account_id=account.id) }}" class="btn btn-sm btn-outline-secondary">
                         Link Existing Contact
                     </a>
                 </div>
            </div>
        </div>
        
        {# Related Deals Section - Added #}
        <div class="card card-body border-0 shadow mb-4">
            <h2 class="h5 mb-3">Related Deals ({{ related_deals|length }})</h2>
            {% if related_deals %}
                <ul class="list-group list-group-flush">
                    {% for deal in related_deals %}
                        <li class="list-group-item px-0">
                            <a href="{{ url_for('crm.view_deal', deal_id=deal.id) }}">{{ deal.name }}</a> - {{ deal.stage }} (${{ "%.2f"|format(deal.amount) }})
                            <small class="d-block text-muted">Expected Close: {{ deal.expected_close_date.strftime('%Y-%m-%d') if deal.expected_close_date else 'N/A' }}</small>
                            {% if deal.contact %}
                                <small class="d-block text-muted">Primary Contact: <a href="{{ url_for('crm.view_contact', contact_id=deal.contact.id) }}">{{ deal.contact.full_name }}</a></small>
                            {% endif %}
                        </li>
                    {% endfor %}
                </ul>
            {% else %}
                <p class="text-muted">No deals associated with this account. <a href="{{ url_for('crm.create_deal', account_id=account.id) }}">Add a new deal</a>.</p>
            {% endif %}
        </div>

        {# Related Tasks Section - Added #}
        <div class="card card-body border-0 shadow mb-4">
            <h2 class="h5 mb-3">Related Tasks ({{ related_tasks|length }})</h2>
            {% if related_tasks %}
                <ul class="list-group list-group-flush">
                    {% for task in related_tasks %}
                        <li class="list-group-item px-0">
                            <a href="{{ url_for('crm.edit_task', task_id=task.id) }}">{{ task.title }}</a> - Status: {{ task.status }}
                            <small class="d-block text-muted">Due: {{ task.due_date.strftime('%Y-%m-%d') if task.due_date else 'N/A' }} | Priority: {{ task.priority }}</small>
                            {% if task.contact %}
                                <small class="d-block text-muted">Associated Contact: <a href="{{ url_for('crm.view_contact', contact_id=task.contact.id) }}">{{ task.contact.full_name }}</a></small>
                            {% endif %}
                            {% if task.deal %}
                                <small class="d-block text-muted">Associated Deal: <a href="{{ url_for('crm.view_deal', deal_id=task.deal.id) }}">{{ task.deal.name }}</a></small>
                            {% endif %}
                        </li>
                    {% endfor %}
                </ul>
            {% else %}
                <p class="text-muted">No tasks associated with this account. <a href="{{ url_for('crm.manage_tasks', account_id=account.id) }}">Add a new task</a>.</p>
            {% endif %}
        </div>

        {# Recent Notes from Contacts - Added #}
        <div class="card card-body border-0 shadow mb-4">
            <h2 class="h5 mb-3">Recent Notes from Contacts ({{ recent_contact_notes|length }})</h2>
            {% if recent_contact_notes %}
                <ul class="list-group list-group-flush">
                    {% for note in recent_contact_notes %}
                        <li class="list-group-item px-0">
                            <p class="mb-1"><strong><a href="{{ url_for('crm.view_contact', contact_id=note.contact.id) }}">{{ note.contact.full_name }}</a>:</strong> {{ note.text }}</p>
                            <small class="text-muted">
                                {{ note.timestamp.strftime('%Y-%m-%d %H:%M') if note.timestamp else 'No timestamp' }}
                                {% if note.author %}
                                    - By: {{ note.author.first_name }} {{ note.author.last_name }}
                                {% endif %}
                            </small>
                        </li>
                    {% endfor %}
                </ul>
            {% else %}
                <p class="text-muted">No recent notes from contacts linked to this account.</p>
            {% endif %}
        </div>
    </div>
</div>
{% endblock %} 