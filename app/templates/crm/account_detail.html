{% extends "crm/layout.html" %}

{% block page_title %}{{ account.name }} - Account Details{% endblock %}

{% block page_description %}Details for company {{ account.name }}.{% endblock %}

{% block page_content %}
<div class="row mb-4 align-items-center">
    <div class="col-lg-7 col-md-6">
        <div class="d-flex align-items-center flex-wrap">
            <h1 class="h2 mb-0 me-3 text-break">{{ account.name }}</h1>
            <span class="badge {{ 'bg-success' if account.status == 'Customer' else ('bg-warning text-dark' if account.status == 'Prospect' else ('bg-secondary' if account.status == 'Former Customer' else 'bg-info text-dark')) }} p-2 fs-6 rounded-pill my-1">{{ account.status or 'No Status' }}</span>
        </div>
    </div>
    <div class="col-lg-5 col-md-6 text-md-end mt-3 mt-md-0">
        <a href="{{ url_for('crm.edit_account', account_id=account.id) }}" class="btn btn-primary btn-sm me-2 mb-1">
            <i class="bi bi-pencil-fill me-1"></i> Edit
        </a>
        <div class="btn-group me-2 mb-1">
            <button type="button" class="btn btn-outline-secondary btn-sm dropdown-toggle" data-bs-toggle="dropdown" aria-expanded="false">
                <i class="bi bi-plus-lg"></i> New
            </button>
            <ul class="dropdown-menu dropdown-menu-end">
                <li><a class="dropdown-item" href="{{ url_for('crm.create_deal', account_id=account.id) }}"><i class="bi bi-cash-coin me-2"></i>New Deal</a></li>
                <li><a class="dropdown-item" href="{{ url_for('crm.manage_tasks', account_id=account.id) }}"><i class="bi bi-check2-square me-2"></i>New Task</a></li>
                <li><hr class="dropdown-divider"></li>
                <li><a class="dropdown-item" href="{{ url_for('crm.create_contact', account_id=account.id) }}"><i class="bi bi-person-plus-fill me-2"></i>New Contact for this Account</a></li>
            </ul>
        </div>
        <button type="button" class="btn btn-outline-danger btn-sm me-2 mb-1" data-bs-toggle="modal" data-bs-target="#confirmDeleteModalAccount">
            <i class="bi bi-trash-fill me-1"></i> Delete
        </button>
    </div>
</div>

{# Confirmation Modal for Delete Account - ADDED #}
<div class="modal fade" id="confirmDeleteModalAccount" tabindex="-1" aria-labelledby="confirmDeleteModalLabelAccount" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="confirmDeleteModalLabelAccount">Confirm Account Deletion</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <p>Are you sure you want to delete the account "<strong>{{ account.name }}</strong>"?</p>
        <p class="text-danger"><i class="bi bi-exclamation-triangle-fill me-2"></i>This action cannot be undone. Associated contacts will be unlinked, and other related data might be affected.</p>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
        <form method="POST" action="{{ url_for('crm.delete_account', account_id=account.id) }}" style="display: inline-block;">
            <input type="hidden" name="csrf_token" value="{{ generated_csrf_token }}">
            <button type="submit" class="btn btn-danger">Delete Account Permanently</button>
        </form>
      </div>
    </div>
  </div>
</div>

<div class="row">
    {# Left Column #}
    <div class="col-lg-6 mb-4">
        {# Account Overview Card #}
        <div class="card border-0 shadow-sm mb-4">
            <div class="card-header bg-light py-3">
                <h2 class="h5 mb-0 d-flex align-items-center"><i class="bi bi-buildings-fill me-2 text-primary"></i>Account Overview</h2>
            </div>
            <div class="card-body">
                <dl class="row mb-0">
                    <dt class="col-sm-4 text-muted"><i class="fas fa-sitemap fa-fw me-2"></i>Sales Rep</dt>
                    <dd class="col-sm-8">
                        {% if account.sales_rep and account.sales_rep.user %}
                            {{ account.sales_rep.user.name }}
                        {% else %}
                            <span class="text-muted fst-italic">Unassigned</span>
                        {% endif %}
                    </dd>
                    <hr class="my-2 d-sm-none">
                    <dt class="col-sm-4 text-muted"><i class="fas fa-globe fa-fw me-2"></i>Website</dt>
                    <dd class="col-sm-8">
                        {% if account.website %}
                            <a href="{{ account.website if account.website.startswith('http') else 'http://' + account.website }}" target="_blank" rel="noopener noreferrer">
                                {{ account.website }} <i class="fas fa-external-link-alt fa-xs"></i>
                            </a>
                        {% else %}
                            -
                        {% endif %}
                    </dd>
                    <hr class="my-2 d-sm-none">
                    <dt class="col-sm-4 text-muted"><i class="fas fa-phone fa-fw me-2"></i>Phone</dt>
                    <dd class="col-sm-8">{{ account.phone_number or '-' }}</dd>
                    <hr class="my-2 d-sm-none">
                    <dt class="col-sm-4 text-muted"><i class="fas fa-industry fa-fw me-2"></i>Industry</dt>
                    <dd class="col-sm-8">{{ account.industry or '-' }}</dd>
                    <hr class="my-2 d-sm-none">
                    <dt class="col-sm-4 text-muted"><i class="fas fa-map-marker-alt fa-fw me-2"></i>Address</dt>
                    <dd class="col-sm-8" style="white-space: pre-line;">{{ account.address or '-' }}</dd>
                    <hr class="my-2 d-sm-none">
                    <dt class="col-sm-4 text-muted"><i class="fas fa-calendar-plus fa-fw me-2"></i>Added On</dt>
                    <dd class="col-sm-8">{{ account.created_at.strftime('%b %d, %Y') if account.created_at else '-' }}</dd>
                    <hr class="my-2 d-sm-none">
                    <dt class="col-sm-4 text-muted"><i class="fas fa-calendar-check fa-fw me-2"></i>Last Updated</dt>
                    <dd class="col-sm-8">{{ account.updated_at.strftime('%b %d, %Y %H:%M') if account.updated_at else '-' }}</dd>
                </dl>
            </div>
        </div>

        {# Custom Fields Card #}
        {% if custom_fields_data %}
        <div class="card border-0 shadow-sm mb-4">
            <div class="card-header bg-light py-3">
                <h2 class="h5 mb-0 d-flex align-items-center"><i class="bi bi-ui-checks-grid me-2 text-primary"></i>Custom Fields</h2>
            </div>
            <div class="card-body">
                <dl class="row mb-0">
                    {% for field_name, field_value in custom_fields_data.items() %}
                        <dt class="col-sm-4 text-muted"><i class="fas fa-tag fa-xs fa-fw me-2"></i>{{ field_name }}</dt>
                        <dd class="col-sm-8">{{ field_value if field_value is not none else '-' }}</dd>
                        {% if not loop.last %}<hr class="my-2 d-sm-none">{% endif %}
                    {% endfor %}
                </dl>
            </div>
        </div>
        {% else %}
        <div class="card border-0 shadow-sm mb-4">
            <div class="card-header bg-light py-3">
                <h2 class="h5 mb-0 d-flex align-items-center"><i class="bi bi-ui-checks-grid me-2 text-primary"></i>Custom Fields</h2>
            </div>
            <div class="card-body">
                <p class="text-muted text-center py-3">No custom fields defined or set for this account.</p>
            </div>
        </div>
        {% endif %}

        {# Related Contacts Card - Now in Left Column #}
        <div class="card border-0 shadow-sm mb-4">
            <div class="card-header bg-light py-3 d-flex justify-content-between align-items-center">
                <h2 class="h5 mb-0 d-flex align-items-center"><i class="bi bi-people-fill me-2 text-primary"></i>Related Contacts</h2>
                <span class="badge bg-secondary rounded-pill">{{ account.contacts.count() }}</span>
            </div>
            <div class="card-body p-3">
                {% set related_contacts = account.contacts.all() %}
                {% if related_contacts %}
                    <ul class="list-group list-group-flush">
                    {% for contact in related_contacts %}
                        <li class="list-group-item d-flex justify-content-between align-items-center px-0">
                            <div>
                                <a href="{{ url_for('crm.view_contact', contact_id=contact.id) }}" class="text-decoration-none fw-medium">{{ contact.full_name }}</a>
                                <small class="d-block text-muted">{{ contact.job_title or 'No title' }}</small>
                            </div>
                            <a href="{{ url_for('crm.view_contact', contact_id=contact.id) }}" class="btn btn-sm btn-outline-secondary border-0" title="View Contact"><i class="bi bi-eye"></i></a>
                        </li>
                    {% endfor %}
                    </ul>
                {% else %}
                    <div class="text-center py-3">
                        <i class="bi bi-person-bounding-box fs-2 text-muted mb-2"></i>
                        <p class="text-muted mb-2">No contacts linked.</p>
                    </div>
                {% endif %}
                <div class="mt-3 pt-3 border-top">
                     <a href="{{ url_for('crm.create_contact', account_id=account.id) }}" class="btn btn-sm btn-primary me-2"><i class="bi bi-plus-lg me-1"></i>New Contact</a>
                     <a href="{{ url_for('crm.select_contact_to_link_to_account', account_id=account.id) }}" class="btn btn-sm btn-outline-secondary"><i class="bi bi-link-45deg me-1"></i>Link Existing</a>
                 </div>
            </div>
        </div>
    </div> {# End Left Column #}

    {# Right Column #}
    <div class="col-lg-6 mb-4">
        {# Related Deals Card #}
        <div class="card border-0 shadow-sm mb-4">
            <div class="card-header bg-light py-3 d-flex justify-content-between align-items-center">
                <h2 class="h5 mb-0 d-flex align-items-center"><i class="bi bi-cash-coin me-2 text-primary"></i>Related Deals</h2>
                <span class="badge bg-secondary rounded-pill">{{ related_deals|length }}</span>
            </div>
            <div class="card-body p-3">
                {% if related_deals %}
                    <ul class="list-group list-group-flush">
                        {% for deal in related_deals %}
                            <li class="list-group-item px-0">
                                <div class="d-flex w-100 justify-content-between">
                                    <h6 class="mb-1"><a href="{{ url_for('crm.view_deal', deal_id=deal.id) }}" class="text-decoration-none">{{ deal.name }}</a></h6>
                                    <small class="text-success fw-bold">${{ "%.2f"|format(deal.amount) }}</small>
                                </div>
                                <p class="mb-1 text-muted"><span class="badge bg-info me-2">{{ deal.stage }}</span> Exp. Close: {{ deal.expected_close_date.strftime('%b %d, %Y') if deal.expected_close_date else 'N/A' }}</p>
                                {% if deal.contact %}
                                    <small class="d-block text-muted">Primary Contact: <a href="{{ url_for('crm.view_contact', contact_id=deal.contact.id) }}" class="text-decoration-none">{{ deal.contact.full_name }}</a></small>
                                {% endif %}
                            </li>
                        {% endfor %}
                    </ul>
                {% else %}
                    <div class="text-center py-3">
                        <i class="bi bi-piggy-bank-fill fs-2 text-muted mb-2"></i>
                        <p class="text-muted mb-2">No deals found.</p>
                    </div>
                {% endif %}
                 <div class="mt-3 pt-3 border-top">
                    <a href="{{ url_for('crm.create_deal', account_id=account.id) }}" class="btn btn-sm btn-primary"><i class="bi bi-plus-lg me-1"></i>New Deal</a>
                </div>
            </div>
        </div>

        {# Related Tasks Card #}
        <div class="card border-0 shadow-sm mb-4">
            <div class="card-header bg-light py-3 d-flex justify-content-between align-items-center">
                <h2 class="h5 mb-0 d-flex align-items-center"><i class="bi bi-check2-square me-2 text-primary"></i>Related Tasks</h2>
                <span class="badge bg-secondary rounded-pill">{{ related_tasks|length }}</span>
            </div>
            <div class="card-body p-3">
                {% if related_tasks %}
                    <ul class="list-group list-group-flush">
                        {% for task in related_tasks %}
                            <li class="list-group-item px-0">
                                <div class="d-flex w-100 justify-content-between">
                                    <h6 class="mb-1"><a href="{{ url_for('crm.edit_task', task_id=task.id) }}" class="text-decoration-none">{{ task.title }}</a></h6>
                                    <span class="badge {{ 'bg-success' if task.status == 'Completed' else ('bg-warning text-dark' if task.status == 'In Progress' else 'bg-secondary') }}">{{ task.status }}</span>
                                </div>
                                <p class="mb-1 text-muted">Due: {{ task.due_date.strftime('%b %d, %Y') if task.due_date else 'N/A' }} | Priority: {{ task.priority }}</p>
                                {% if task.contact %}<small class="d-block text-muted">For: <a href="{{ url_for('crm.view_contact', contact_id=task.contact.id) }}" class="text-decoration-none">{{ task.contact.full_name }}</a></small>{% endif %}
                                {% if task.deal %}<small class="d-block text-muted">Related Deal: <a href="{{ url_for('crm.view_deal', deal_id=task.deal.id) }}" class="text-decoration-none">{{ task.deal.name }}</a></small>{% endif %}
                            </li>
                        {% endfor %}
                    </ul>
                {% else %}
                     <div class="text-center py-3">
                        <i class="bi bi-list-check fs-2 text-muted mb-2"></i>
                        <p class="text-muted mb-2">No tasks found.</p>
                    </div>
                {% endif %}
                <div class="mt-3 pt-3 border-top">
                    <a href="{{ url_for('crm.manage_tasks', account_id=account.id) }}" class="btn btn-sm btn-primary"><i class="bi bi-plus-lg me-1"></i>New Task</a>
                </div>
            </div>
        </div>

        {# Recent Notes Card #}
        <div class="card border-0 shadow-sm">
            <div class="card-header bg-light py-3 d-flex justify-content-between align-items-center">
                <h2 class="h5 mb-0 d-flex align-items-center"><i class="bi bi-stickies-fill me-2 text-primary"></i>Recent Notes</h2>
                <span class="badge bg-secondary rounded-pill">{{ recent_contact_notes|length }}</span>
            </div>
            <div class="card-body p-3">
                {% if recent_contact_notes %}
                    <ul class="list-group list-group-flush">
                        {% for note in recent_contact_notes %}
                            <li class="list-group-item px-0">
                                <p class="mb-1"><strong><a href="{{ url_for('crm.view_contact', contact_id=note.contact.id) }}" class="text-decoration-none">{{ note.contact.full_name }}</a>:</strong> {{ note.text | safe }}</p>
                                <small class="text-muted">
                                    {{ note.timestamp.strftime('%b %d, %Y %H:%M') if note.timestamp else 'No timestamp' }}
                                    {% if note.author %}
                                        - By: {{ note.author.first_name }} {{ note.author.last_name }}
                                    {% endif %}
                                </small>
                            </li>
                        {% endfor %}
                    </ul>
                {% else %}
                    <div class="text-center py-3">
                        <i class="bi bi-journal-text fs-2 text-muted mb-2"></i>
                        <p class="text-muted mb-2">No recent notes found.</p>
                    </div>
                {% endif %}
            </div>
        </div>
    </div> {# End Right Column #}
</div>

{% endblock %} 